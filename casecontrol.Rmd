---
title: 'Rapid Epidemiological Analysis of Comorbidities and Treatments as risk factors for COVID-19 in Scotland (REACT-SCOT): a population-based case-control study'
author: 
  - name: Paul M McKeigue\textsuperscript{\getAff{Usher}}
    email: paul.mckeigue@ed.ac.uk
    affiliation: HPS
  - name: Amanda Weir 
    affiliation: HPS
  - name: Jen Bishop
    affiliation: HPS
  - name: Stuart J McGurnaghan
    affiliation: IGMM
  - name: Sharon Kennedy
    affiliation: ISD
  - name: David McAllister\textsuperscript{\getAff{Glasgow}} 
    affiliation: HPS
  - name: Chris Robertson\textsuperscript{\getAff{Strathclyde}} 
    affiliation: HPS
  - name: Rachael Wood
    affiliation: ISD
  - name: Nazir Lone
    affiliation: Usher
  - name: Janet Murray
    affiliation: HPS 
  - name: Thomas M Caparrotta 
    affiliation: IGMM
  - name: Alison Smith-Palmer 
    affiliation: HPS
  - name: David Goldberg
    affiliation: HPS
  - name: Jim McMenamin
    affiliation: HPS
  - name: Colin Ramsay
    affiliation: HPS
  - name: Sharon Hutchinson\textsuperscript{\getAff{GCU}} 
    affiliation: HPS
  - name: Helen M Colhoun\textsuperscript{\getAff{IGMM}}
    affiliation: HPS
address: 
  - code: Usher
    address: Usher Institute, College of Medicine and Veterinary Medicine, University of Edinburgh, Teviot Place, Edinburgh EH8 9AG, Scotland. PM - Professor of Genetic Epidemiology and Statistical Genetics. NL - Clinical Senior Lecturer in Critical Care

  - code: IGMM
    address: Institute of Genetics and Molecular Medicine, College of Medicine and Veterinary Medicine, University of Edinburgh, Western General Hospital Campus, Crewe Road, Edinburgh EH4 2XUC, Scotland. HC - AXA Chair in Medical Informatics and Epidemiology. TC - Sir George Alberti Doctoral Fellow in Pharmacoepidemiology. 

  - code: HPS
    address: Public Health Scotland, Meridian Court, 5 Cadogan Street, Glasgow G2 6QE

  - code: Glasgow
    address: Institute of Health and Wellbeing, University of Glasgow, 1 Lilybank Gardens, Glasgow G12 8RZ. DM - Wellcome Trust Intermediate Clinical Fellow and Beit Fellow 

  - code: Strathclyde
    address: Department of Mathematics and Statistics, University of Strathclyde, 16 Richmond Street, Glasgow G1 1XQ. CR - Professor of Public Health Epidemiology

  - code: GCU
    address: School of Health and Life Sciences, Glasgow Caledonian University. SH - Professor of Epidemiology and Population Health 

  - code: ISD
    address: NHS Information Services Division (Public Health Scotland), Gyle Square, 1 South Gyle Crescent, Edinburgh, EH12 9EB.  RW - Consultant in Maternal and Child Health. 

geometry: margin=1in
fontsize: 11pt
linenumbers: true
bibliography: ./covid.bib

header-includes: |
  \let\origquote\quote
  \def\quote{\origquote\itshape}
  \usepackage{soul}
  \usepackage{graphicx}
  \usepackage{longtable}
  \usepackage{booktabs}
  \usepackage{float}
  \usepackage{array}
  \usepackage{booktabs}
  \usepackage{longtable}
  \usepackage{lscape}
output: 
#  pdf_document:
  rticles::plos_article:
    includes:
      in_header: ./preamble.tex
    latex_engine: lualatex
    fig_caption: true
    keep_tex: true

always_allow_html: true
csl: ./plos.csl
urlcolor: blue
---

On behalf of Public Health Scotland COVID-19 Health Protection Study Group

```{r functions, echo=FALSE}
library(knitr)
library(kableExtra)
library(bookdown)

# rmarkdown::render("casecontrol.Rmd", output_file="casecontrol_supptables.pdf"); rmarkdown::render("response_reviewers.md")

options(knitr.table.format = "latex") # adds tab: prefix to labels
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)

source("helperfunctions.R")

table.demog.append <- table.ethnicsmr.aug
colnames(table.demog.append) <- colnames(table.demog.aug)[1:4]
table.demog.append[, 4] <- as.character(table.demog.append[, 4])
table.demog.aug[, 4] <- as.character(table.demog.aug[, 4])
                                         
table.demog.append <- data.frame(varname=c(rownames(table.demog.aug),
                                           rownames(table.ethnicsmr.aug)),
                                 rbind(table.demog.aug[, 1:4], table.demog.append))
table.demog.append <- table.demog.append[-(1:3), ] # drop onomap classification

table.densities <- rbind(summary(demog.densities),
                         summary(listed.densities),
                         summary(full.densities))[, 1:6]

table.ethnicsmr.missing <- paste.colpercent(with(cc.severe, table(is.na(ethnic5.smr), CASE)))

table.notlisted.scrip <- paste.colpercent(with(cc.severe[notlisted, ], table(scrip.any, CASE)))
table.notlisted.diag <- paste.colpercent(with(cc.severe[notlisted, ], table(diag.any, CASE)))
table.notlisted.scripordiag <- paste.colpercent(with(cc.severe[notlisted, ], table(scripordiag, CASE)))

table.lt60.notlisted.scripordiag <- paste.colpercent(with(cc.severe[cc.severe$AGE < 60 & notlisted, ], table(scripordiag, CASE)))

freqs.all <- as.data.frame(freqs.all)
table.agegr <- as.data.frame(table.agegr)

delay <- with(cc.severe, table(DATE_OF_REGISTRATION - Date.Death))
percent.withindays <- round(100 * cumsum(delay) / sum(delay))

pctonly <- function(x) gsub("([0-9]+ \\()(.*)(\\))", "\\2", x)

rr.pval <- function(r, p) {
    r <- gsub(",", " to", r)
    p <- gsub("ensuremath\\{", "\\ensuremath\\{p=", p)
    p <- gsub("times", "\\\\times", p)
    gsub("\\)", paste0(", \\\\", p, "\\)"), r)
}

##rr.pval(table.agegr.all[1, 3], table.agegr.all[1, 4])


```

\newpage

# Abstract

_Background_--   The objectives of this study were to identify risk factors for severe  COVID-19 and to lay the basis for risk stratification based on demographic data and health records. 

_Methods and Findings_ -- The design was a matched case-control study. Severe COVID-19 was defined as either a positive nucleic acid test for SARS-CoV-2 in the national database followed by entry to a critical care unit or death within 28 days, or a death certificate with COVID-19 as underlying cause.  Up to ten controls per case matched for sex, age and primary care practice were selected from the national population register.  For this analysis based on ascertainment of positive test results up to `r gsub("^0", "", format(max(cc.severe$SPECIMENDATE, na.rm=TRUE), "%d %B %Y"))`, entry to critical care up to `r gsub("^0", "", format(maxdate.sicsag, "%d %B %Y"))` and deaths registered up to `r format(max(cc.severe$DATE_OF_REGISTRATION, na.rm=TRUE), "%d %B %Y")` there were `r nrow(cc.severe[CASE==0])` controls and `r nrow(cc.severe[CASE==1])` cases of whom `r table.demog.append["Care home", 3]` were care home residents.  All diagnostic codes from the past five years of hospitalisation records and all drug codes from prescriptions dispensed during the past 240 days were extracted.  Rate ratios for severe COVID-19 were estimated by conditional logistic regression.  

In a logistic regression using the age-sex distribution of the national population, the odds ratios for severe disease were `r round(exp(10 * logistic.coeffs[3, 1]), 2)` for a 10-year increase in age and `r round(exp(-logistic.coeffs[2, 1]), 2)` for male sex.  In the case-control analysis, the strongest risk factor was residence in a care home, with rate ratio (95% CI) `r rr.pval(table.agegr.all[1, 3], table.agegr.all[1, 4])`.  Univariate rate ratios (95% CIs) for conditions listed by public health agencies as conferring high risk were `r rr.pval(table.agegr.all["Type 1 diabetes", 3], table.agegr.all["Type 1 diabetes", 4])` for Type 1 diabetes, `r rr.pval(table.agegr.all["Type 2 diabetes", 3], table.agegr.all["Type 2 diabetes", 4])` for Type 2 diabetes, 
`r rr.pval(table.agegr.all["Ischaemic heart disease", 3], table.agegr.all["Ischaemic heart disease", 4])` for ischemic heart disease,
`r rr.pval(table.agegr.all["Other heart disease", 3], table.agegr.all["Other heart disease", 4])` for other heart disease, 
`r rr.pval(table.agegr.all["Asthma or chronic airway disease", 3], table.agegr.all["Asthma or chronic airway disease", 3])` for chronic lower respiratory tract disease, 
`r rr.pval(table.agegr.all["Chronic kidney disease or transplant recipient", 3], table.agegr.all["Chronic kidney disease or transplant recipient", 4])` for chronic kidney disease, 
`r rr.pval(table.agegr.all["Neurological (except epilepsy) or dementia", 3], table.agegr.all["Neurological (except epilepsy) or dementia", 4])` for neurological disease, 
`r rr.pval(table.agegr.all["Liver disease", 3], table.agegr.all["Liver disease", 4])` for chronic liver disease and 
`r rr.pval(table.agegr.all["Immune deficiency or suppression", 3], table.agegr.all["Immune deficiency or suppression", 4])` for immune deficiency or suppression.

`r pctonly(freqs.all["listed.any", 2])` of cases and `r pctonly(freqs.all["listed.any", 1])` of controls had at least one listed condition (`r pctonly(table.agegr["Any listed condition", 2])` of cases and `r pctonly(table.agegr["Any listed condition", 1])` of controls under age 40).  Severe disease was associated with encashment of at least one prescription in the past nine months and with at least one hospital admission in the past five years [rate ratios `r table.agegr.all["Any prescription", 3]`] and `r table.agegr.all["Any admission", 3]` respectively] even after adjusting for the listed conditions.  In those without listed conditions significant associations with severe disease were seen across many hospital diagnoses and drug categories. Age and sex provided `r round(cases.Lambda.agesex, 2)` bits of information for discrimination.  A model based on demographic variables, listed conditions, hospital diagnoses and prescriptions provided an additional `r table.densities[3, 5]` bits (C-statistic `r table.densities[3, 3]`).  A limitation of this study is that records from primary care were not available. 

_Conclusions_ -- We have shown that along with older age and male sex, severe COVID-19 is strongly associated with past medical history across all age groups. Many comorbidities beyond the risk conditions designated by public health agencies contribute to this.  A risk classifier that uses all the information available in health records, rather than only a limited set of conditions, will more accurately discriminate between low-risk and high-risk individuals who may require shielding until the epidemic is over.  

\newpage

# Author summary
## Why was this study done? 
* Most people infected with the SARS-CoV-2 coronavirus do not become seriously ill: risk of severe or fatal disease is associated with older age, male sex, and conditions designated by public health agencies including asthma, diabetes and heart disease. 

* Studies reported so far have focused on these "listed conditions", but have not examined medical records systematically to identify possible risk factors for severe COVID-19. 

* The objectives of this study were to identify risk factors for severe COVID-19 and to lay the basis for risk stratification based on electronic health records. 

## What did the researchers do and find? 
* Using Scotland's capability for linking electronic health records, we report the first systematic study of the relation of severe or fatal COVID-19 to pre-existing health conditions and other risk factors.  

* Residents in care homes were 21 times more likely to develop severe disease than people of the same age and sex not living in care homes.  

* The conditions associated with increased risk include not only those already designated by public health agencies -- asthma, diabetes, heart disease, disabling neurological disease, kidney disease -- but other diagnoses that are associated with frailty and poor health such as strokes and a history of falls.  

* In those without any listed conditions, use of prescribed drugs acting on the digestive system or nervous system is associated with increased risk of severe COVID-19.  

## What do these findings mean? 
* The risk to younger individuals without any recent history of hospital admission or use of prescription drugs is very low. 

* This study lays a basis for calculating a risk score based on electronic health records for every individual in the population, and using it to advise those at high risk of severe disease to shield themselves when there is a COVID-19 epidemic in their locality. 

# Background
Case series from many countries have suggested that in those with severe COVID-19 the prevalence of diabetes and cardiovascular disease is higher than expected.  For example in a large UK series the commonest co-morbidities were cardiac disease, diabetes, chronic pulmonary disease and asthma [@docherty_features_2020-1]. However there are also anecdotal reports of apparently healthy young persons succumbing to disease [@mcgoogan_why_2020].

Quantification of the risk associated with characteristics and co-morbidities has been limited by the lack of comparisons with the background population [@zhou_clinical_2020;@grasselli_baseline_2020;@guan_clinical_2020].  Two recent studies in the UK have included population comparators and have reported associations of in hospital test positive persons and COVID-19 death in hospital with co-morbidities including diabetes, asthma and heart disease [@niedzwiedz_ethnic_2020; @williamson_opensafely_2020].  These studies  have focused on conditions presumptively listed by public health agencies as increasing risk for COVID-19 based on case series data.  

Here we examine the frequency of sociodemographic factors and  these listed conditions in  all people with severe COVID-19 disease in  Scotland compared to matched controls from the general population.  In those without listed conditions we report a systematic examination of the hospitalisation record and prescribing history in severe  COVID-19 cases  compared to controls. The objectives were to identify  risk factors for severe COVID-19 and to lay the basis for risk stratification based on a predictive model.  

# Methods
The protocol of the study dated 16 April 2020, together with all code used to prepare this manuscript is available in a public [repository](https://github.com/pmckeigue/covid-scotland_public/).  We modified the original protocol to align the list of risk conditions to be consistent with those designated by public health agencies, and extended the list of drug classes under study to include all drugs. The study was registered with the European Network of Centres for Pharmacoepidemiology and Pharmacovigilance (ENCEPP number [EUPAS35558](http://www.encepp.eu/encepp/viewResource.htm?id=35559)). All record linkage studies using NHS data in Scotland are governed by the Public Benefit and Privacy Panel for Health and Social Care, which includes patient and public representatives.  Identifiable data were extracted by the Public Health Scotland CHI database and linkage team and de-identified before provision to the analysis team.

## Case definition and selection of matched controls
 All individuals testing positive for nucleic acid for SARS-CoV-2 were ascertained through the Electronic Communication of Surveillance in Scotland (ECOSS) database, which captures all virology testing in all NHS laboratories nationally. Linkage to other datasets was carried out using the Community Health Index (CHI) number, a unique identifier used in all care systems in Scotland.  Admissions to critical care were obtained from the Scottish Intensive Care Society and Audit Group (SICSAG) database that captures admission to all critical care (intensive care or high dependency) units and has returned a daily census of patients in critical care from the beginning of the COVID-19 epidemic. Death registrations were obtained from linkage to the National Register of Scotland.  Severe or fatal COVID-19 was defined by either (1) a positive nucleic acid test followed by entry to critical care or death within 28 days; or (2) a death certificate with COVID-19 as underlying cause. Using this definition ensures ascertainment of all severe cases even if they die without testing positive or entering critical care, whatever selection policies may have limited entry to critical care.

For each case, the CHI database was used to select up to ten controls matched for sex, one-year age band and registered with the same primary care practice, who were alive and resident in Scotland on the day as the first date that the case tested positive.  For fatal cases who had not tested positive, the incident date was assigned as 14 days before death.  To ensure that cases and controls were representative of the same population at risk, the 0.6% of cases who were recorded on the CHI database as no longer alive and resident in Scotland on the day that ECOSS recorded them as testing positive were also excluded.  As this is an incidence density sampling design, it is possible and correct for an individual to appear in the dataset more than once, initially as a control and subsequently as a case.  
For this analysis based on ascertainment of positive test results up to `r gsub("^0", "", format(max(cc.severe$SPECIMENDATE, na.rm=TRUE), "%d %B %Y"))`, entry to critical care up to `r gsub("^0", "", format(maxdate.sicsag, "%d %B %Y"))` and deaths registered up to `r format(max(cc.severe$DATE_OF_REGISTRATION, na.rm=TRUE), "%d %B %Y")` there were `r nrow(cc.severe[CASE==1])` cases and `r nrow(cc.severe[CASE==0])` controls.  Among fatal cases, `r percent.withindays[6]`% of deaths were registered within 5 days.  

## Demographic data
Residence in a care home was ascertained from the CHI database. Socioeconomic status was assigned as the Scottish Index of Multiple Deprivation (SIMD), an indicator based on postal code.  For `r gsub("(.*\\()(.*)\\)", "\\2", table.ethnicsmr.missing[1, 1])` of controls and `r gsub("(.*\\()(.*)\\)", "\\2", table.ethnicsmr.missing[1, 2])` of cases self-assigned ethnicity, based on the categories used in the Census, had been recorded in Scottish Morbidity Records (SMR).  

## Morbidity and drug prescribing
For all cases and controls, ICD-10 diagnostic codes were extracted from the last five years of hospital discharge records in the Scottish Morbidity Record (SMR01), excluding records of discharges less than 25 days before testing positive for SARS-CoV-2 and using all codes on the discharge. Diagnostic coding under ICD chapters V (Mental, Behavioural and Neurodevelopmental) and XV (Pregnancy) is incomplete as most psychiatric and maternity unit returns are not captured in SMR01. British National Formulary (BNF) drug codes for dispensed prescriptions issued in primary care were extracted from the Scottish Prescribing Information System [@alvarez-madrazo_data_2016].  A cutoff date of 15 days before the incident date (date of testing positive for SARS-CoV-2, or 14 days before death for fatal cases without a positive test) was set, and prescriptions dispensed in a 240-day interval before this cutoff date were included. For this analysis prescription codes from BNF chapters 14 and above, comprising dressings, appliances, vaccines, anaesthesia and other preparations were grouped as "Other". 

We began by scoring a specific list of conditions that have been designated as risk conditions for COVID-19 by public health agencies [@nhs_whos_2020].  A separate list of conditions designates "clinically extremely vulnerable" individuals who were advised to shield themselves completely since 24 March 2020: this list includes solid organ transplant recipients, people receiving chemotherapy for cancer, and people with cystic fibrosis or leukaemia.  We did not separately tabulate these conditions as we expected these individuals to be underrepresented among cases if shielding was adequate.  

The eight listed conditions were scored based on diagnostic codes in any hospital discharge record during the last five years, or encashed prescription of a drug for which the only indications are in that group of diagnostic codes. The R script included as supplementary material contains the derivations of these variables from ICD-10 codes and BNF drug codes.  Diagnosed cases of diabetes were identified through linkage to the national diabetes register (SCI-Diabetes), with a clinical classification of diabetes type as Type 1, Type 2 or Other/Unknown. 

## Statistical methods
To estimate the relation of cumulative incidence and mortality from COVID-19 to age and sex, logistic regression models were fitted to the proportions of cases and non-cases in the Scottish population, using the estimated population of Scotland in mid-year 2019 which were available by one-year age group up to age 90 years. To allow for possible non-linearity of the relationship of the logit of risk to age, we also fitted generalized additive models, implemented in the R function `gam::gam`, with default smoothing function. 

For the case-control study, all estimates of associations with severe COVID-19 were based on conditional logistic regression, implemented as Cox regression in the R function `survival::clogit` [@therneau_modeling_2000].  Among those cases and controls without any of the pre-defined conditions we then further examined associations of ICD-10 and BNF chapter with severe COVID-19.  Restriction of cases and controls, for instance to exclude those with any listed condition, may generate strata that do not contain at least one case and at least one control, but these strata are ignored by the conditional logistic regression model as they do not contribute to the conditional likelihood.  With incidence density sampling, the odds ratios in conditional logistic regression models are equivalent to rate ratios.  Note that odds ratios in a matched case control study are based on the conditional likelihood and the unconditional odds ratios calculable from the frequencies of exposure in cases and controls will differ from these and should not be used [@breslow_estimation_1978].  Although matching on primary care practice will match to some extent for associated variables such as care home residence, socioeconomic disadvantage and prescribing practice, the effects of these variables are still estimated correctly by the conditional odds ratios but with less precision than in an unmatched study of the same size [@breslow_estimation_1978].

To construct risk prediction models, we used stepwise regression alternating between forward and backward steps to maximize the AIC, implemented in the R function `stats::step`. To evaluate the contribution of the listed conditions to risk prediction, and the incremental contribution of other information in hospitalisation and prescription records after assigning these conditions, predictive models were constructed from three sets of variables: a baseline set consisting only of demographic variables, a set that included indicator variables for each listed condition, and an extended set that included demographic, variables, indicator variables for listed conditions and indicator variables for hospital diagnoses in each ICD-10 chapter and prescriptions in each BNF chapter.  

The performance of the risk prediction model in classifying cases versus non-cases of severe COVID-19 was examined by `r nfold`-fold cross-validation. We calculated the performance calculated over all test folds using the C-statistic but also using the "expected information for discrimination" $\Lambda$ expressed in bits [@mckeigue_quantifying_2019].  The use of bits (logarithms to base 2) to quantify information is standard in information theory: one bit can be defined as the quantity of information that halves the hypothesis space.  Although readers may be unfamiliar with the expected information for discrimination $\Lambda$, it has several properties that make it more useful than the C-statistic for quantifying increments in the performance of a risk prediction model [@mckeigue_quantifying_2019].  A key advantage of using $\Lambda$ is that contributions of independent predictors can be added.  Thus in this study we can add the predictive information from a logistic model of age and sex in the general population to the predictive information provided by other risk factors from the case-control study matched for age and sex.  

# Results
## Incidence and mortality from severe COVID-19 in the Scottish population
Figure \ref{fig:rates} shows the relationships of incidence and mortality rates to age for each sex separately.  The relationship of mortality to age is almost exactly linear on a logit scale, and the lines for male and female mortality are almost parallel.  In models that included age and sex as covariates, the odds ratio associated with a 10-year increase in age was `r round(exp(10*logistic.coeffs[3, 1]), 2)` for all severe disease and `r round(exp(10*logistic.coeffs[3, 2]), 2)` for fatal disease. The odds ratio associated with male sex was `r round(exp(-logistic.coeffs[2, 1]), 2)` for all severe disease and `r round(exp(-logistic.coeffs[2, 2]), 2)` for fatal disease. For severe cases as defined in this study, the sex differential is narrow up to about age 50 but widens between ages 50 and 70 years.  Thus at younger ages the ratio of critical care admissions to total fatalities is higher in women than in men, but that at later ages the ratio of critical admissions to total fatalities is higher in men.  

## Risk factors
### Sociodemographic factors
Table \ref{tab:demog} shows univariate associations of demographic factors with severe disease.  Residence in a care home was by far the strongest risk factor for severe disease.  Higher risk of severe disease was also associated with socioeconomic deprivation.  In the   `r gsub("(.*\\()(.*)\\)", "\\2", table.ethnicsmr.missing[1, 2])` of cases  and  `r gsub("(.*\\()(.*)\\)", "\\2", table.ethnicsmr.missing[1, 1])` of controls  in whom ethnicity had been recorded in the Scottish Morbidity Record, there were few non-White individuals and the confidence limits for the rate ratios by ethnic group were wide. 

### Factors derived from hospitalisation and prescribing records
Prevalence of the listed conditions in cases and controls by age band is shown in Table \ref{tab:agegr}.  `r gsub("\\\\", "", table.agegr["Any listed condition", 2])` of the cases aged under 40 years had at least one listed condition, compared with only `r gsub("\\\\", "", table.agegr["Any listed condition", 1])` of the controls.  In those aged 75+ years `r gsub("\\\\", "", table.agegr["Any listed condition", 8])` of the cases and `r gsub("\\\\", "", table.agegr["Any listed condition", 7])` of the controls had at least one listed condition.  Among those aged under 40 years, `r table.agegr["Diagnosis or prescription", 2]` of the cases and `r table.agegr["Diagnosis or prescription", 1]` of the controls had either a hospital admission in the last five years or a dispensed prescription in the last 240 days.  Differences in prescription rates between cases and controls narrowed with increasing age.

Over all age groups, `r freqs.all["listed.any", 2]` of severe cases and `r freqs.all["listed.any", 1]` of controls had at least one of the listed conditions.  As shown in Table \ref{tab:listed.conditions.allages}, all the listed conditions were more frequent in cases than controls except for immune conditions in the 75+ age group.  The rate ratio associated with type 1 diabetes was higher than that for type 2 diabetes.  The rate ratio was `r table.agegr.all[8, 3]` for ischemic heart disease compared to `r table.agegr.all[9, 3]` for the broad category "other heart disease".  In multivariable analysis ischemic heart disease was not independently associated with severity whereas other heart disease remained strongly associated. In those without a listed condition `r table.notlisted.scripordiag[2, 2]` of the cases and `r table.notlisted.scripordiag[2, 1]` of the controls had either a recent admission or a prescription.  In those aged under 60 years without a listed condition, `r table.lt60.notlisted.scripordiag[2, 2]` of the cases and `r table.lt60.notlisted.scripordiag[2, 1]` had either a recent admission or a prescription. 

Supplementary Tables \ref{tab:listed.conditions.lt60} to \ref{tab:listed.conditions.ge75} examine these associations by age group, with the 0-39 and 40-59 year age bands combined.  All listed conditions were associated with severe disease in each age band.  In those aged under 60 years, the rate ratio was `r tables.agegr[[1]]["Type 1 diabetes", 3]` for Type 1 diabetes and `r tables.agegr[[1]]["Type 2 diabetes", 3]` for Type 2 diabetes.  The multivariable analyses shown in Table \ref{tab:listed.conditions.allages} and \ref{tab:listed.conditions.lt60} to \ref{tab:listed.conditions.ge75} show that overall and in each age group  group  any admission to hospital in the past five years were strongly and independently associated with severe disease even after adjusting for care home residence and listed conditions. Dispensing of any prescription in the past year was associated with severe disease  in multivariable analyses in the two younger age bands.  Table \ref{tab:fatal} shows that in each age group the proportion of fatal cases who had not had either a hospital admission in the last five years or a dispensed prescription in the last year was 	very low. 

## Comparison of fatal and non-fatal cases
Supplementary Table \ref{tab:casegr} shows a breakdown of severe cases by test-positive status, entry to critical care, and fatal versus non-fatal outcome.  Severe cases who entered critical care were much younger than severe cases never entering critical care.  The majority of severe cases from residential care homes never entered critical care. Among fatal cases who did not enter critical care. the distribution of age and other risk factors was similar in those with and without a positive test result, except that the proportion of care home residents was higher among those without a positive test result.  Among those entering critical care the median age and the proportion of males and prevalence or prior comorbidities were higher in fatal than in non-fatal cases.  

## Systematic analysis of diagnoses associated with severe disease
The association of severe COVID-19 with prior hospital admission was examined further by testing for association of hospitalisations at each ICD-10 chapter level with severe COVID-19, among those without any of the listed conditions.  These results are shown in Supplementary Table \ref{tab:conditions}.  In univariate analyses, almost all ICD-10 chapters, with the exception of Chapters VII (eye), VIII (ear) and XV (pregnancy) were associated with increased risk of severe disease.  In a multivariable analysis the strongest associations were with diagnoses in ICD chapters IV (mental disorders) and X (respiratory). Supplementary Table \ref{tab:icdsubchapters} extracts univariate associations with ICD-10 subchapters in those without any listed conditions.  This table is filtered to show only subchapters for which there are at least 50 cases and controls and the univariate p-value is <0.001.  This shows that many subchapter diagnoses are associated with markedly higher risk of severe COVID-19. 

## Associations of prescribed drugs with severe disease 
As shown in Table \ref{tab:listed.conditions.allages} and supplementary tables \ref{tab:listed.conditions.lt60} to \ref{tab:listed.conditions.ge75} ,  encashment of at least one prescription in the last year was associated with severe disease.  The univariate rate ratio associated with this variable varies from `r tables.agegr[[1]]["Any prescription", 3]` in those aged under 60 years to `r tables.agegr[[3]]["Any prescription", 3]` in those aged 75 years and over.  In a multivariable analysis adjusting for care home residence, any hospital admission and listed conditions, these rate ratios were reduced to `r tables.agegr[[1]]["Any prescription", 5]` and `r tables.agegr[[3]]["Any prescription", 5]` respectively.  

To investigate this further, we partitioned the "Any prescription" variable into indicator variables for each chapter of the British National Formulary, in which drugs are grouped by broad indication, and restricted the analysis to those without one of the listed conditions.  Table \ref{tab:drugs} shows these associations.  In univariate analyses, prescriptions in almost all BNF chapters were associated with severe disease.  In a multivariable analysis of all chapters, the strongest independent associations with severe disease were with prescriptions in chapters 1 (gastrointestinal), 4 (central nervous system), 5 (infections), 9 (nutrition and blood) and 14+ (other, mostly dressings and appliances).  

## Construction of a multivariable risk prediction model 
 The variables retained from the extended variable set (demographic variables, listed conditions, hospital diagnoses in each ICD-10 chapter, prescriptions in each BNF chapter) are shown in Table \ref{tab:stepwise}. Coefficients for specific conditions here should not be interpreted as effect estimates, as global variables for any hospital diagnosis and any listed condition have been included in the model. The predictive performance of the model chosen by stepwise regression was estimated by `r nfold`-fold cross-validation.  Observed and predicted case status were compared within each stratum over all test folds.  Table \ref{tab:xvalid} shows that in comparison with using only demographic variables and listed conditions, using the extended variable set increased the C-statistic from `r table.densities[2, 3]` to `r table.densities[3, 3]` and the expected information for discrimination $\Lambda$ from `r table.densities[2, 5]` bits to `r table.densities[3, 5]` bits.  

Figure \ref{fig:wevid} shows the distributions in cases and controls of the weight of evidence favouring case over control status from the model based on the extended variable set with a footnote explaining how $\Lambda$ is derived. This shows, as expected for a multifactorial classifier, that the distribution in controls is approximately Gaussian: there is no clear divide between high-risk and low-risk individuals of the same age and sex. In cases there is a bimodal distribution, where the second mode represents care home residents.  Figure \ref{fig:roc} shows the receiver operating characteristic curve with a footnote explaining its derivation from the distributions of the weights of evidence.  

This estimate of `r table.densities[3, 5] ` bits for the information conditional on age and sex obtained from the matched case-control study can be added to the information for discrimination `r round(cases.Lambda.agesex, 2)` bits obtained from the logistic regression on age and sex in the population using age and sex to estimate the total information for discrimination of a risk classifier that would be obtained in the population as `r table.densities[3, 5] + round(cases.Lambda.agesex, 2)` bits. 

# Discussion  
## Sociodemographic factors
This analysis confirms that risk for severe COVID-19 is associated with increasing age, male sex and socioeconomic deprivation.  The slope of the relationship of severe disease (on the scale of log odds) to age is less steep than the slope of the relationship of fatal disease to age.  <!---Another way of expressing this is that the fatality rate of severe disease increases with age. Although the relationships of mortality to age are linear and parallel for men and women, the fatality rate of severe disease is lower in women than in men up to age 50 and higher in women than in men between ages 50 and 70.  This may reflect either variation in the biology of the disease, or differential selection for entry to critical care.--->  Residence in a care home was associated with a `r round(as.numeric(substr(table.agegr.all[1, 3], 1, 4)))`-fold increased rate of severe COVID-19 in this age matched analysis, reduced to `r round(as.numeric(substr(table.agegr.all[1, 5], 1, 4)))`-fold by adjustment for listed conditions. This excess risk is likely to reflect both the spread of the epidemic in care homes and residual confounding by frailty.

As the proportion of the Scottish population that is of non-White ethnicity is low and the assignment of ethnicity in this dataset is incomplete, the confidence intervals for the rate ratios associated with South Asian and Black ethnicity are wide.  Studies from England [@williamson_opensafely_2020; @niedzwiedz_ethnic_2020; @ho_modifiable_2020] have reported elevations in risk of hospitalised and fatal COVID-19 in non-White ethnic groups; in the OpenSAFELY study the risk ratios for fatal COVID-19 associated with Black and Asian ethnicity were 1.7 and 1.6 respectively.  The confidence intervals in this study are compatible with the effect sizes estimated in England. 

## Co-morbidities
We have confirmed that the moderate risk conditions designated by the NHS and other agencies [@nhs_whos_2020] are associated with increased risk of severe COVID-19.  The rate ratios of `r round(as.numeric(substr(table.agegr.all["Type 1 diabetes", 3], 1, 4)), 1)` for Type 1 diabetes and `r round(as.numeric(substr(table.agegr.all["Type 2 diabetes", 3], 1, 4)), 1)` for Type 2 diabetes are broadly similar to those reported in the UK Biobank [@ho_modifiable_2020] and OpenSAFELY [@williamson_opensafely_2020] studies.  We confirm the higher risk with asthma and chronic lung disease and liver disease reported in these and earlier studies.  The rate ratios associated with these risk conditions vary with age: for example the rate ratio associated with diabetes is higher at younger ages. An unexpected finding was that the risk associated with other forms of heart disease is higher than that associated with ischaemic heart disease.  This category includes conditions such as atrial fibrillation, cardiomyopathies and heart failure. One of the highest rate ratios is that associated with chronic kidney disease.  Prevention of nosocomial transmission in dialysis units may help to reduce this risk.  Over all age groups, `r gsub("(.*\\()(.*)\\)", "\\2", freqs.all["listed.any", 2])` of severe cases had at least one of these listed conditions. In this dataset it is not possible to examine adequately the risk associated with neoplasms as we cannot separately identify those who were advised to shield themselves because they had active neoplasms of lymphoid or hematopoietic tissue or were receiving treatments that affect the immune system. We plan to explore this in a separate study based on linkage to records of shielding advice.  In patients without any listed conditions, further systematic evaluation of past hospitalisation history did not reveal a sparse set of underlying conditions; instead many diagnoses were associated with severe COVID-19.  

Public health agencies [@ghebreyesus_who_2020] and media reports of apparently healthy young people succumbing to severe COVID-19 [@mcgoogan_why_2020] have disseminated the message that all are at risk of severe COVID-19 whatever their age or health status.  However we found that half of cases under 40 years had at least one of the listed conditions and among those who did not have one of these conditions, the proportions who had at least one prior hospitalisation or dispensed prescription were higher in cases than in controls.  In all age groups, very few of the fatal cases had not had either a hospital admission in the past five years or a dispensed prescription in the past year. 

A striking finding of this study was the association of severe COVID-19 with dispensing of at least one prescription in the 240-day interval preceding the cutoff of 15 days before diagnosis, only partly explained by higher rates of prescribing among those with listed conditions.  Partitioning of this association between BNF chapters, which represent broad indication-based drug classes, showed that prescription of drugs for the gastrointestinal and central nervous systems, together with nutritional supplements, contributed to this association.  Although it is likely that most associations of severe COVID-19 with drug prescribing are attributable to the indications for which these drugs were prescribed, or to more diffuse frailty especially in older persons, causal effects of drugs or direct effects of polypharmacy on susceptibility cannot be ruled out.  These associations are explored in a separate paper.  

## Relevance to policy
As lockdown restrictions are eased, there is general agreement that vulnerable individuals will require shielding, even if the restart of the epidemic can be slowed or suppressed by mass testing, contact tracing and isolation of those who test positive.  The "stratify and shield" policy option [@mckeigue_evaluation_2020], in which high-risk individuals comprising up to 15% of the population are shielded for a defined period while the epidemic is allowed to run relatively quickly in low-risk individuals until population-level immunity is attained, depends critically on informative risk discrimination.  So too does the similarly named "segment and shield " option [@bunnik_segmentation_2020] which has the opposite objective of keeping transmissions low.  Although in this preliminary study we have not used the full repertoire of machine learning methods available for constructing predictive models, we have shown that a model based on health records provides `r table.densities[3, 5]` bits of information for discrimination conditional on age and sex.  Adding this to the `r round(cases.Lambda.agesex, 2)` bits provided by age and sex gives a total information for discrimination of `r round(table.densities[3, 5] + cases.Lambda.agesex, 1)` bits.  We have shown elsewhere that this level of predictive performance would allow at least 80% of those at risk of severe or fatal disease to be allocated to a shielded group comprising no more than 15% of the population [@mckeigue_evaluation_2020]. 

As awareness grows of how risk varies between individuals, individuals will seek information about their own level of risk.  A key implication of our results is that risk of severe or fatal disease is multifactorial.  The rate ratio of `r round(exp(10 * logistic.coeffs[3, 1]), 1)` associated with a 10-year increase in age is stronger than the rate ratios associated with common diseases such as asthma or Type 2 diabetes that are listed as conditions associated with high risk.  A corollary of this is that a crude classification based on assigning all persons with a listed condition to a group for whom shielding is recommended will have poor specificity, as one quarter of those aged 60-74 years in the population have at least one of the listed conditions we examined.  It will also exclude many people at high risk because they have multiple risk factors each of small effect. A more meaningful way to score risk for an individual would be to use all available information to calculate a "COVID age" as the age at which the average risk for someone of the same sex in the population equates to the risk for the individual under study. Thus the rate ratio of `r rr <- round(as.numeric(gsub(" .+", "", table.agegr.all["Type 1 diabetes", 3])), 1); rr` associated with Type 1 diabetes equates to an increase of `r round(log(rr) / logistic.coeffs[3, 1], 1)` years in COVID age.  In Scotland it is technically possible to use existing electronic health records to calculate a risk score for every individual in the population, though more work would be required to develop this as a basis for official advice and individual decisions.  

## Methodological strengths and weaknesses
Most reports of disease associations with COVID-19 have been case series.  There have been few reports based on evaluating these associations in the population through cohort or case-control studies.  With this matched case control design using incidence density sampling, we have been able to estimate rate ratios conditional on age and sex.  The OpenSafely study has explored associations of a similar set of risk conditions with in-hospital COVID-19 deaths [@williamson_opensafely_2020], but has not yet reported a systematic evaluation of the rest of the medical record including prescription records.  Although we have records of encashment of prescriptions, we do not at present have access to other primary care data, which would contain additional information on morbidity and measurements such as body mass index.  A strength of our study however is that hospital discharge diagnoses are coded to ICD-10 by trained coders, in contrast to the coding systems used in primary care databases that do not map to recognized disease classifications.  Associations with ethnicity and other sociodemographic factors are not necessarily generalizable from Scotland to other populations.  

# Conclusion
This study confirms that risk of severe COVID-19 is associated with sociodemographic factors and with chronic conditions such as diabetes, asthma, circulatory disease and others. However the associations with pre-existing disease are not just with a small set of conditions that contribute to risk, but with many conditions as demonstrated by associations with past medical and prescribing history in relation to multiple physiological systems.  As countries attempt to emerge from lockdown whist protecting vulnerable individuals, multivariable classifiers rather than crude rule-based approaches will be needed to define those most at risk of developing severe disease.

<!---
# Declarations
## Information governance
This study was conducted under approvals from the [Public Benefit and Privacy Panel for Health and Social Care](https://www.informationgovernance.scot.nhs.uk/pbpphsc/) that allow Public Health Scotland staff to link datasets.  Datasets were de-identified before analysis.  

## Data availability
The component datasets used here are available via the Public Benefits Privacy Panel for Health at https://www.informationgovernance.scot.nhs.uk/pbpphsc/ for researchers who meet the criteria for access to confidential data. All source code used for derivation of variables, statistical analysis and generation of this manuscript is available on  https://github.com/pmckeigue/covid-scotland_public  

## Funding

No funding was received for this work.

## Conflicts of interest
The authors declare no conflicts of interest.
--->
# Acknowledgements
We thank all staff in critical care units who submitted data to the SICSAG database, the Scottish Morbidity Record Data Team, the staff of the National Register of Scotland, the Public Health Scotland Terminology Services, the HPS COVID-19 Laboratory & Testing cell and the NHS Scotland Diagnostic Virology Laboratories, and Nicola Rowan (HPS) for coordinating this collaboration. 

## Public Health Scotland COVID-19 Health Protection Study Group
Alice Whettlock$^1$, Allan McLeod$^1$, Andrew Gasiorowski$^1$, Andrew Merrick$^1$, Andy McAuley$^1$, April Went$^1$, Calum Purdie$^1$, Colin Fischbacher$^1$, Colin Ramsay$^1$, David Bailey$^1$, David Henderson$^1$, Diogo Marques$^1$, Eisin McDonald$^1$, Genna Drennan$^1$, Graeme Gowans$^1$, Graeme Reid$^1$, Heather Murdoch$^1$, Jade Carruthers$^1$, Janet Fleming$^1$, Jade Carruthers$^1$, Joseph Jasperse$^1$, Josie Murray$^1$, Karen Heatlie$^1$, Lindsay Mathie$^1$, Lorraine Donaldson$^1$, Martin Paton$^1$, Martin Reid$^1$, Melissa Llano$^1$, Michelle Murphy-Hall$^1$, Paul Smith$^1$, Ros Hall$^1$, Ross Cameron$^1$, Susan Brownlie$^1$, Adam Gaffney$^2$, Aynsley Milne$^2$, Christopher Sullivan$^2$, Edward McArdle$^2$, Elaine Glass$^2$, Johanna Young$^2$, William Malcolm$^2$, Jodie McCoubrey $^2$

1  Health Protection Scotland (Public Health Scotland), Meridian Court, 5 Cadogan Street, Glasgow G2 6QE. 

2  NHS National Services Scotland, Meridian Court, 5 Cadogan Street, Glasgow G2 6QE. 


# References

<div id="refs"></div>
\newpage

# Figures

```{r plotrates, echo=FALSE, fig.pos="H", fig.cap="\\label{fig:rates}Incidence of severe and fatal COVID-19 in Scotland by age and sex: generalized additive models fitted to severe and fatal cases for males and females separately", out.width="0.8\\textwidth"}


breaks.gam <- c("1/20,000", "1/10,000", "1/5,000",
                "1/2000", "1/1000", "1/500",
                "1/200", "1/100")
theme_set(
    theme_gray(base_size = 12)
)

p.incidence <- ggplot(data=gam, aes(x=Age, y=value, colour=Sex, linetype=Status)) +
    geom_line() +
    scale_x_continuous(name="Age", limits=c(20, 90),
                       breaks=seq(20, 80, by=20),
                       labels=seq(20, 80, by=20)) + 
    scale_x_continuous(limits=c(20, 90), expand=c(0, 0)) +
    scale_y_continuous(name="Risk (logit scale)",
                       breaks=car::logit(c(5E-5, 1E-4, 2E-4,
                                           5E-4, 1E-3, 2E-3,
                                           5E-3, 1E-2)),
                       labels=breaks.gam,
                       limits=car::logit(c(2E-5, 5E-3))) +
    theme(axis.title=element_text(size=12)) +
    theme(legend.position=c(0.85, 0.3))
p.incidence

```

\newpage

```{r plotwdists, echo=FALSE, fig.pos="H", fig.cap="\\label{fig:wevid}Cross-validation of model chosen by stepwise regression using extended variable set: class-conditional distributions of weight of evidence", out.width="0.8\\textwidth"}

p.wdists <- plotWdists(densities=full.densities, distlabels=c("Crude", "Adjusted")) +
    theme_grey(base_size = 16) +
    theme(axis.title=element_text(size=14)) +
    theme(legend.title=element_blank()) +
    theme(legend.position=c(0.85, 0.75))

p.wdists

```

## Footnote for Figure \ref{fig:wevid} 
For each individual, the risk prediction model outputs the posterior probability of being a case, which can also be expressed as the posterior odds. Dividing the posterior odds by the prior odds gives the likelihood ratio favouring case over non-case status for an individual.  The weight of evidence $W$ is the logarithm of this ratio. The  distributions of $W$ in cases and controls in the test data are plotted in Figure \ref{fig:wevid}.  For a classifier, the further apart these curves are, the better the predictive performance.  The expected information for discrimination $\Lambda$ is the average of the mean of the distribution of $W$ in cases and minus 1 times the mean of the distribution of $W$ in controls.  The distributions have been adjusted by taking a weighted average to make them mathematically consistent [@mckeigue_quantifying_2019]. 

\newpage

```{r plotroc, echo=FALSE, fig.pos='H', fig.cap="\\label{fig:roc}Cross-validation of model chosen by stepwise regression using extended variable set: receiver operating characteristic curve", out.width="0.8\\textwidth"}

p.roc <- plotroc(full.densities) +
    scale_color_manual(values=c("orange", "purple"), labels=c("Crude", "Adjusted")) + 
    coord_fixed(ratio=1) +
    theme_grey(base_size = 16) +
    theme(axis.title=element_text(size=14)) +
    theme(legend.title=element_blank()) + 
    theme(legend.position=c(0.8, 0.2)) + 
    scale_x_reverse(limits=c(1, 0), expand=c(0, 0)) +
    scale_y_continuous(limits=c(0, 1), expand=c(0, 0)) +
    xlab("Specificity (reverse scale)") +
    ylab("Sensitivity")
p.roc
```

```{r tiff, echo=FALSE, warning=FALSE, message=FALSE}

if(FALSE) {
## Height maximum: 2625 pixels (at 300 dpi).
## Resolution 300  600 dpi
tiff("Fig1.tiff", res=300, width=1800, height=1500)
p.incidence
dev.off()
tiff("Fig2.tiff", res=300, width=2100, height=1800)
p.wdists
dev.off()
tiff("Fig3.tiff", res=300, width=2100, height=1800)
p.roc
dev.off()
}

```

## Footnote for Figure \ref{fig:roc}
The receiver operator characteristic (ROC) curve is computed by calculating at each value of the risk score the sensitivity and specificity of a classifier that uses this value as the threshold for classifying cases and non-cases.  Using the adjusted distributions from Figure \ref{fig:wevid} gives a curve that is concave downwards. The C-statistic is the area under this curve, computed as the probability of correctly classifying a case/noncase pair using the risk score, evaluated over all possible such pairs in the dataset.  

\newpage

# Tables
```{r demog, echo=FALSE, warning=FALSE, message=FALSE}
options(knitr.kable.NA = '')

nonmissing.ethnic <- with(cc.severe[!is.na(ethnic4.smr)], table(CASE))

knitr::kable(table.demog.append[, 1:5],
             escape=FALSE, 
             booktabs=TRUE,
             label="demog",
             row.names=FALSE,
             col.names=c("", clean.header(colnames(table.demog.aug)[1:2]),
                         "Rate ratio (95\\% CI)", "$p$-value"),
             align="lcccc", 
             caption="Univariate associations of severe disease with demographic factors") %>%
    column_spec(column=1, width="3cm") %>%
    column_spec(column=2, width="2cm") %>%
    column_spec(column=3, width="1.8cm") %>%
    column_spec(column=4, width="2.5cm") %>%
    kableExtra::group_rows("SIMD quintile", 1, 5, bold=FALSE) %>%
        kableExtra::group_rows(paste0("Ethnicity based on Scottish Morbidity Record (",
                                      nonmissing.ethnic[1], " controls, ",
                                      nonmissing.ethnic[2], " cases)"), 7, 10, bold=FALSE,
               hline_before=TRUE, latex_gap_space="10pt") %>% 
    kable_styling(latex_options="hold_position") 

```

\newpage

```{r agegr, echo=FALSE, warning=FALSE, message=FALSE}

rownames(table.agegr) <- replace.names(rownames(table.agegr))
table.agegr.print <- table.agegr[c(1:4, 6, 8:nrow(table.agegr)), ] 
knitr::kable(table.agegr.print, 
             escape=FALSE, 
             booktabs=TRUE,
             label="agegr",
			 linesep=c(rep('', 4), '\\addlinespace', rep('', 9)), 
             align=rep("c", 8), 
             caption="Frequencies of risk factors in cases and controls, by age group") %>%
    column_spec(column=1, width="4cm") %>%
    column_spec(column=2:3, width="1.6cm") %>%
    column_spec(column=4:7, width="1.8cm") %>%
    column_spec(column=8:9, width="2cm") %>%
    add_header_above(c(" "=1, "0-39 years"=2, "40-59 years"=2,
                       "60-74 years"=2, "75+ years"=2)) %>%
    landscape() %>%
    kable_styling(latex_options="hold_position") 

```

```{r listed.conditions.allages, echo=FALSE, warning=FALSE, message=FALSE}

knitr::kable(table.agegr.all[-4, ],
             escape=FALSE, 
             booktabs=TRUE,
             label="listed.conditions.allages",
			 linesep=c(rep('', 2), '\\addlinespace', rep('', 9)), 
             digits=c(0, 0, 0, 200, 0, 200), 
             col.names=c(clean.header(colnames(table.agegr.all)[1:2]),
                         "Rate ratio (95\\% CI)", "$p$-value",
                         "Rate ratio (95\\% CI)", "$p$-value"),
             align=rep("c", 6), 
             caption="Associations of severe disease with listed conditions over all age groups") %>%
    column_spec(column=1, width="5cm") %>%
    column_spec(column=2:7, width="2.5cm") %>%
    add_header_above(c(" "=3, "Univariate"=2, "Multivariable"=2)) %>%
    landscape() %>%
    kable_styling(latex_options="hold_position") 

```

```{r scripordiag.fatal, echo=FALSE, warning=FALSE, message=FALSE}

knitr::kable(table.scripordiag.fatal, 
             escape=FALSE, 
             booktabs=TRUE,
             label="fatal",
             align=rep("c", 2), 
             caption="Proportions of fatal cases and matched controls without and with a  dispensed prescription or hospital diagnosis, by age group") %>%
   kableExtra::group_rows("Age <60", 1, 2) %>%
   kableExtra::group_rows("Age 60-74", 3, 4) %>%
   kableExtra::group_rows("Age 75+", 5, 6) %>%
   kable_styling(latex_options="hold_position") 

```

\newpage

```{r infodiscrim, echo=FALSE, warning=FALSE, message=FALSE}

rownames(table.densities) <- c("Demographic only",
                               "Demographic + listed conditions",
                               "Extended variable set")
table.densities[, 6] <- round(table.densities[, 6] - table.densities[1, 6], 1)

colnames(table.densities) <- gsub("Model-based", "Adjusted", colnames(table.densities))

knitr::kable(table.densities, 
             booktabs=TRUE,
             escape=FALSE,
              row.names=TRUE,
             label="xvalid",
             align=rep("c", 6),
             caption="Prediction of severe COVID-19: cross-validation of models chosen by stepwise regression") %>%
    column_spec(column=1, width="2.5cm") %>%
    column_spec(column=2:7, width="1.4cm") %>%
    kable_styling(latex_options="hold_position") 
 
```

\newpage
\beginsupplement

# Supplementary tables

```{r listed.conditions.lt60, echo=FALSE, warning=FALSE, message=FALSE}

knitr::kable(tables.agegr[[1]][-4, ],
             escape=FALSE, 
             booktabs=TRUE,
             label="listed.conditions.lt60",
			 linesep=c(rep('', 2), '\\addlinespace', rep('', 9)), 
             digits=c(0, 0, 0, 200, 0, 200), 
             col.names=c(clean.header(colnames(tables.agegr[[1]])[1:2]),
                         "Rate ratio (95\\% CI)", "$p$-value",
                         "Rate ratio (95\\% CI)", "$p$-value"),
             align=rep("c", 6), 
             caption="Associations of severe disease with listed conditions in those aged less than 60") %>%
    column_spec(column=1, width="4cm") %>%
    column_spec(column=2:7, width="2.7cm") %>%
   add_header_above(c(" "=3, "Univariate"=2, "Multivariable"=2)) %>%
    landscape() %>%
    kable_styling(latex_options="hold_position") 

```

```{r listed.condition.60to74, echo=FALSE, warning=FALSE, message=FALSE}

knitr::kable(tables.agegr[[2]][-4, ],
             escape=FALSE, 
             booktabs=TRUE,
             label="listed.conditions.60to74",
			 linesep=c(rep('', 2), '\\addlinespace', rep('', 9)), 
             digits=c(0, 0, 0, 200, 0, 200), 
             col.names=c(clean.header(colnames(tables.agegr[[2]])[1:2]),
                         "Rate ratio (95\\% CI)", "$p$-value",
                         "Rate ratio (95\\% CI)", "$p$-value"),
             align=rep("c", 6), 
             caption="Associations of severe disease with listed conditions in those aged 60-74 years") %>%
    column_spec(column=1, width="4cm") %>%
    column_spec(column=2:7, width="2.7cm") %>%
   add_header_above(c(" "=3, "Univariate"=2, "Multivariable"=2)) %>%
    landscape() %>%
    kable_styling(latex_options="hold_position") 

```

```{r listed.condition.75plus, echo=FALSE, warning=FALSE, message=FALSE}

knitr::kable(tables.agegr[[3]][-4, ],
             escape=FALSE, 
             booktabs=TRUE,
             label="listed.conditions.ge75",
			 linesep=c(rep('', 2), '\\addlinespace', rep('', 9)), 
             digits=c(0, 0, 0, 200, 0, 200), 
             col.names=c(clean.header(colnames(tables.agegr[[3]])[1:2]),
                         "Rate ratio (95\\% CI)", "$p$-value",
                         "Rate ratio (95\\% CI)", "$p$-value"),
             align=rep("c", 6), 
             caption="Associations of severe disease with listed conditions in those aged 75 years and over") %>%
    column_spec(column=1, width="4cm") %>%
   column_spec(column=2:7, width="2.7cm") %>%
    add_header_above(c(" "=3, "Univariate"=2, "Multivariable"=2)) %>%
    landscape() %>%
    kable_styling(latex_options="hold_position") 

```

```{r casegr, echo=FALSE, warning=FALSE, message=FALSE}

knitr::kable(table.casegr,
             escape=FALSE, 
             booktabs=TRUE,
			 longtable=TRUE, 
             label="casegr",
             col.names=paste(c("Critical care, non-fatal", "Critical care, fatal",
                               "No critical care, fatal", "No critical care, fatal"),
                             paste0(rep("(", 4),
                                    with(cc.severe, table(severe.casegr)), rep(")", 4))), 
             caption="Comparison of severe non-fatal and fatal cases, by test positive status and entry to critical care") %>%
    add_header_above(c(" "=1, "Test-positive"=3, "No positive test"=2)) %>%
    add_header_above(c(" "=1, "Non-fatal"=1, "Fatal"=3)) %>%
    column_spec(column=2:8, width="3cm") %>%
    landscape() %>%
    kable_styling(latex_options="hold_position") 

```

```{r conditions, echo=FALSE, warning=FALSE, message=FALSE}

rownames(table.conditions.aug) <- gsub("_", " ", rownames(table.conditions.aug))
knitr::kable(table.conditions.aug,
             escape=FALSE, 
             booktabs=TRUE,
             label="conditions",
             digits=c(0, 0, 0, 200, 0, 200), 
             col.names=c(clean.header(colnames(table.conditions.aug)[1:2]),
                         "Rate ratio (95\\% CI)", "$p$-value",
                         "Rate ratio (95\\% CI)", "$p$-value"),
             align=rep("c", 6), 
             caption="Associations of severe disease with hospital diagnoses by ICD chapter in last 5 years, in those without any listed condition") %>%
    column_spec(column=1, width="4cm") %>%
    add_header_above(c(" "=3, "Univariate"=2, "Multivariable"=2)) %>%
    landscape() %>%
    kable_styling(latex_options="hold_position") 

```

```{r drugs, echo=FALSE, warning=FALSE, message=FALSE}

rownames(table.drugs.aug) <- gsub("_", " ", rownames(table.drugs.aug))
knitr::kable(table.drugs.aug,
             escape=FALSE, 
             booktabs=TRUE,
             label="drugs",
             digits=c(0, 0, 0, 200, 0, 200), 
             col.names=c(clean.header(colnames(table.drugs.aug)[1:2]),
                         "Rate ratio (95\\% CI)", "$p$-value",
                         "Rate ratio (95\\% CI)", "$p$-value"),
             align=rep("c", 6),
             caption="Associations of severe disease with prescribed drugs by BNF chapter in those without any listed condition") %>%
    column_spec(column=1, width="4.5cm") %>%
    add_header_above(c(" "=3, "Univariate"=2, "Multivariable"=2)) %>%
    landscape() %>%
    kable_styling(latex_options="hold_position") 
```

```{r icdsubchapters, echo=FALSE, warning=FALSE, message=FALSE}
clean.header <- function(x) {
    x <- gsub("\\.\\.", " (", x)
    x <- gsub("\\.",  ")", x)
    return(x)
}

rownames(table.icdsubchapters) <- gsub("_", " ", rownames(table.icdsubchapters))
                                       
knitr::kable(table.icdsubchapters[grep("times", table.icdsubchapters$u.pvalue), ],
             escape=FALSE, 
             booktabs=TRUE,
			 longtable=TRUE, 
             label="icdsubchapters",
			 linesep=c('', '\\addlinespace', # 2 bacterial
                       rep('', 3), '\\addlinespace', # 4 neoplasms
                           '\\addlinespace', # 1 metabolic
                       '', '\\addlinespace', # 2 nervous
                           '\\addlinespace', # 1 circulatory
                       '', '\\addlinespace', # 2 respiratory
                           '\\addlinespace', # 1 skin
                       '', '\\addlinespace', # 2 urinary
                       rep('', 8)),  # 8 symptoms, injuries
             col.names=c(clean.header(colnames(table.icdsubchapters)[1:2]),
                         "Rate ratio (95\\% CI)", "$p$-value"),
             align=rep("c", 6), 
             caption="Univariate associations of severe disease with hospital diagnoses by ICD subchapters in those without any listed conditions: rows retained are those with p < 0.001 and at least 50 cases and controls") %>%
    column_spec(column=1, width="13cm") %>%
    column_spec(column=2:3, width="1.6cm") %>%
    column_spec(column=5, width="1.5cm") %>%
    landscape() %>%
    kable_styling(latex_options="hold_position") 

```

```{r model, echo=FALSE, warning=FALSE, message=FALSE}

z <- stepwise.full[, 4]
pchar <- as.character(signif(stepwise.full[, 5], 1))
pchar[pchar == "0"] <- pnorm.extreme(z[pchar == "0"])
pchar <- as.character(pvalue.latex(pchar))

retained.full <- as.data.frame(stepwise.full[, c(1, 5)])
retained.full[, 1] <- round(retained.full[, 1], 2)
retained.full[, 2] <- pchar
    
rownames(retained.full) <- gsub("\\.quintile", "\\.quintile ", rownames(retained.full))
rownames(retained.full) <- gsub("([a-z])1", "\\1", rownames(retained.full))
rownames(retained.full) <- gsub("care.home", "", rownames(retained.full))
rownames(retained.full) <- gsub("dm\\.type", "", rownames(retained.full))
rownames(retained.full) <- gsub("SIMD\\.quintile", "quintile", rownames(retained.full))

rownames(retained.full) <- replace.names(rownames(retained.full))
rownames(retained.full) <- gsub("\\_", " ", rownames(retained.full))

knitr::kable(retained.full, 
             booktabs=TRUE,
             escape=FALSE,
             label="stepwise",
             col.names=c("log rate ratio", "$p$-value"), 
             align=rep("c", 2),
             caption="Stepwise regression: variables retained in model for severe disease") %>%
    kableExtra::group_rows("SIMD - quintile 1 as reference", 2, 5, bold=FALSE) %>%
    kableExtra::group_rows("Diabetes - non-diabetic as reference", 6, 8, bold=FALSE) %>%
    kable_styling(latex_options="hold_position") 

```
