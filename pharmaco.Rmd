---
title: 'Associations of severe COVID-19 with polypharmacy in the REACT-SCOT case-control study (draft only, not to be quoted)'
author: 
  - name: Paul M McKeigue\textsuperscript{\getAff{Usher}}
    email: paul.mckeigue@ed.ac.uk
    affiliation: HPS
  - name: Sharon Kennedy
    affiliation: ISD
  - name: Amanda Weir 
    affiliation: HPS
  - name: Jen Bishop
    affiliation: HPS
  - name: Stuart J McGurnaghan
    affiliation: IGMM
  - name: David McAllister\textsuperscript{\getAff{Glasgow}} 
    affiliation: HPS
  - name: Chris Robertson\textsuperscript{\getAff{Strathclyde}} 
    affiliation: HPS
  - name: Rachael Wood
    affiliation: ISD
  - name: Nazir Lone
    affiliation: Usher
  - name: Janet Murray
    affiliation: HPS 
  - name: Thomas M Caparrotta 
    affiliation: IGMM
  - name: Alison Smith-Palmer 
    affiliation: HPS
  - name: David Goldberg
    affiliation: HPS
  - name: Jim McMenamin
    affiliation: HPS
  - name: Colin Ramsay
    affiliation: HPS
  - name: Sharon Hutchinson\textsuperscript{\getAff{GCU}} 
    affiliation: HPS
  - name: Helen M Colhoun\textsuperscript{\getAff{IGMM}}
    affiliation: HPS
address: 
  - code: Usher
    address: Usher Institute, College of Medicine and Veterinary Medicine, University of Edinburgh, Teviot Place, Edinburgh EH8 9AG, Scotland. PM - Professor of Genetic Epidemiology and Statistical Genetics. NL - Clinical Senior Lecturer in Critical Care

  - code: IGMM
    address: Institute of Genetics and Molecular Medicine, College of Medicine and Veterinary Medicine, University of Edinburgh, Western General Hospital Campus, Crewe Road, Edinburgh EH4 2XUC, Scotland. HC - Axa Chair in Medical Informatics and Epidemiology. TC - Sir George Alberti Doctoral Fellow in Pharmacoepidemiology. 

  - code: HPS
    address: Public Health Scotland, Meridian Court, 5 Cadogan Street, Glasgow G2 6QE

  - code: Glasgow
    address: Institute of Health and Wellbeing, University of Glasgow, 1 Lilybank Gardens, Glasgow G12 8RZ. DM - Wellcome Trust Intermediate Clinical Fellow and Beit Fellow 

  - code: Strathclyde
    address: Department of Mathematics and Statistics, University of Strathclyde, 16 Richmond Street, Glasgow G1 1XQ. CR - Professor of Public Health Epidemiology

  - code: GCU
    address: School of Health and Life Sciences, Glasgow Caledonian University. SH - Professor of Epidemiology and Population Health 

  - code: ISD
    address: NHS Information Services Division (Public Health Scotland), Gyle Square, 1 South Gyle Crescent, Edinburgh, EH12 9EB.  RW - Consultant in Maternal and Child Health. 

geometry: margin=1in
fontsize: 11pt
linenumbers: true
bibliography: ./covid.bib
date: "This version compiled `r gsub('^0', '', format(Sys.time(), '%d %B %Y'))`"
header-includes: |
  \let\origquote\quote
  \def\quote{\origquote\itshape}
  \usepackage{graphicx}
  \usepackage{longtable}
  \usepackage{booktabs}
  \usepackage{float}
  \usepackage{array}
  \usepackage{booktabs}
  \usepackage{longtable}
  \usepackage{lscape}
output: 
#  pdf_document:
  rticles::nejm_article:
    includes:
      in_header: ./preamble.tex
    latex_engine: lualatex
    fig_caption: true
    keep_tex: true
csl: ../csl/styles/the-new-england-journal-of-medicine.csl
urlcolor: red

# rmarkdown::render("pharmaco.Rmd", output_file="pharmaco.pdf"); cat(system("./wc.manuscript.sh"), "\n")

# abstract limit 250 words

---

On behalf of Public Health Scotland COVID-19 Health Protection Study Group

```{r functions, echo=FALSE, message=FALSE}
library(knitr)
library(kableExtra)

source("helperfunctions.R")

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
options(knitr.kable.NA = '')

stepwise.drop.subparas[, 1] <- gsub("subpara\\.", "", stepwise.drop.subparas[, 1])

firstrow.neg <- which(stepwise.drop.subparas[, 3] < 0)[1]
rows.print <- firstrow.neg:nrow(stepwise.drop.subparas)

```

\newpage
	
# Abstract

_Background_ -- Dispensing of at least one prescription in the past year is a risk factor fo severe COVID-19 in Scotland, even in those without diagnoses of conditions designated as conferring increased risk. 

_Methods_ -- In the REACT-SCOT case-control study, ten controls were matched for sex, age and general practice to each of the `r nrow(cc.severe[CASE==1])` cases of severe COVID-19 in Scotland since the start of the epidemic.  Cases and controls were linked to records of hospital discharges since June 2015 and dispensed prescriptions issued in primary care since June 2019.  

*Results* -- In those without a diagnosed risk condition, severe COVID-19 was strongly associated with polypharmacy; the rate ratio (95% CI) associated with dispensing of 12 or more drug classes versus none was `r table.numdrugsgr.listed.any[">12", 4]`.  Cardiovascular drugs did not contribute to this association: the largest independent contributors were proton pump inhibitors (PPI) and analgesics.  For both PPI and opiate-containing analgesics, there were dose response relationships to severe COVID-19 that were strongest in those aged under 75 years: rate ratios were `r table.dosegr.protonpump["0-74 years: 2 or more", 4]` for $\ge 2$ DDDs/day of PPI and `r table.dosegr.opiate["0-74 years: >50", 4]` for $\ge 50$ MME opiates, The association was stronger with recent than with non-recent exposure. 
 
*Conclusions* -- In Scotland severe COVID-19 is associated with polypharmacy and this is not easily explained by co-morbidity.  Although the evidence for causality of proton pump inhibitors and opiates is not conclusive, these results reinforce existing guidance on reducing overprescribing of these drug classes and limiting inappropriate polypharmacy. 

\newpage

# Background
In the initial analysis of REACT-SCOT, a matched case control study of severe COVID-19 in Scotland, we reported a strong association of severe COVID-19 with having had at least one prescription dispensed in the past year [@mckeigue_rapid_2020].  The univariate rate ratios associated with at least one prescription varied from 3.8 in those aged under 60 years to 2.3 in those aged 75 years and over.  This association persisted after adjusting for care home residence, hospital admission in the last five years, and diagnoses of conditions designated by public health agencies as conferring vulnerability to COVID-19 (hereafter listed conditions).  The objective of this study was to investigate this association.  

# Methods
The design of the REACT-SCOT case-control study has been described in detail elsewhere [@mckeigue_rapid_2020].  In brief, all individuals testing positive for nucleic acid for SARS-CoV-2 in Scotland were ascertained through the Electronic Communication of Surveillance in Scotland (ECOSS) database.  Admissions to critical care were obtained from the Scottish Intensive Care Society and Audit Group (SICSAG) database that captures admission to all critical care (intensive care or high dependency) units. Death registrations up to `r format(max(cc.severe$Date.Death, na.rm=TRUE), "%d %B %Y")` were obtained from linkage to the National Register of Scotland.  Severe or fatal COVID-19 was defined by either (1) a positive nucleic acid test followed by entry to critical care or death within 28 days; or (2) a death certificate with COVID-19 as underlying cause. 

For each case, the Community Health Index database was used to select ten controls matched for sex, one-year age band and registered with the same primary care practice, who were alive on the same day as the first date that the case tested positive.  For fatal cases who had not tested positive, the incident date was assigned as 14 days before death.  For this analysis based on ascertainment of positive test results up to `r gsub("^0", "", format(max(cc.severe$SPECDATE, na.rm=TRUE), "%d %B %Y"))` and deaths up to `r format(max(cc.severe$Date.Death, na.rm=TRUE), "%d %B %Y")` there were `r nrow(cc.severe[CASE==1])` cases and `r nrow(cc.severe[CASE==0])` controls.  

## Morbidity and drug prescribing
For all `r table(cc.severe$CASE)[2]` cases and `r table(cc.severe$CASE)[1]` controls, all ICD-10 diagnostic codes were extracted from the last five years of hospital discharge records in the Scottish Morbidity Record (SMR01), excluding records of discharges less than 25 days before testing positive for SARS-CoV-2, and from the national cancer registry. Diagnoses of diabetes were extracted from linkage to the national diabetes register.  British National Formulary (BNF) drug codes for all prescriptions dispensed since 1 June 2019 were extracted from the Scottish Prescribing Information System [@alvarez-madrazo_data_2016], excluding prescriptions dispensed 15 days or less before testing positive for SARS-CoV-2. The BNF classification groups drugs by seven-digit subparagraph codes that generally correspond to drugs classed by mode of action.  For this analysis prescription codes from chapters 14 and above, comprising dressings, appliances, vaccines, anaesthesia and other preparations were grouped as "Other".  Defined daily doses (DDDs) of each of the five proton pump inhibitors in the BNF were obtained from the [DDD/ATC Index](https://www.whocc.no/atc_ddd_index/) of the WHO Collaborating Centre for Drug Statistics Methodology.  Morphine milligram equivalents (MMEs) for opiates were obtained from the website of the [Faculty of Pain Medicine](https://fpm.ac.uk/opioids-aware-structured-approach-opioid-prescribing/dose-equivalents-and-changing-opioids).  Average daily doses of proton pump inhibitors (as DDDs) and opiates (as MME) were calculated for each individual as the sum of (conversion factor $\times$ strength $\times$ quantity dispensed) divided by (observation period $\times$ DDD).  The dispensed daily dose of opiate was calculated as the sum over all opiate-containing items. 

As described previously, we derived indicator variables for a list of conditions that have been designated as risk conditions for COVID-19 by public health agencies [@nhs_whos_2020]: diabetes, heart disease, asthma or chronic obstructive airway disease, chronic kidney disease, disabling neurological disease, liver disease and immunodeficiency or immunosuppression.  ICD-10 diagnostic and BNF drug codes used to derive these conditions are available with the [ENCEPP registration](http://www.encepp.eu/encepp/openAttachment/documents.otherDocument-0/35565).  Socioeconomic status was encoded as the quintile of the postcode-based Scottish Index of Multiple Deprivation (SIMD). 

# Statistical analysis 
Rate ratios for severe COVID-19 (hereafter COVID-19) were estimated from conditional logistic regression models, implemented as Cox regression in the R function `survival::clogit`. To investigate which drug classes contribute to the association of severe COVID-19 with number of drug classes dispensed, we used a backward stepwise variable selection procedure. Starting with a global predictor defined as the sum of indicator variables for all distinct drug classes (BNF subparagraph codes), at each iteration the procedure computed the log-likelihood of models with care home status and number of drug classes dispensed as covariates, in which each drug class was dropped from the total number of drug classes.  The model with the highest log-likelihood was used to select which drug class should be dropped.  This procedure was repeated with the retained variables until only a single drug class remained.  

# Results
## Relation of severe COVID-19 to polypharmacy 
We began by constructing an index of polypharmacy as the number of drug classes (BNF subparagraph codes) for which at least one prescription had been dispensed during the period of observation (from 1 June 2019 to 15 days before the date of testing positive). Table \ref{tab:numdrugs.listed.any} shows that the COVID-19 was associated with polypharmacy in those without any listed condition.  In those with a listed condition the direction of this association was reversed: those with dispensed prescriptions of 1 to 12 drug classes were at lower risk than those with no dispensed prescriptions. To study further the relationship with polypharmacy, we restricted the analysis to those without a diagnosis of a listed condition.  As prescribing of multiple drugs for primary and secondary prevention of cardiovascular disease is in accordance with evidence-based guidelines, we partitioned the number of drug classes dispensed between cardiovascular and other drugs.  In a model with two covariates -- number of cardiovascular drug classes and number of other drug classes -- the rate ratios per drug class for severe COVID-19 were respectively `r table.jointcardiovasc[1, 4]` and `r table.jointcardiovasc[2, 4]`. 

## Associations with drug classes
We next examined univariate associations of dispensing of each of the `r length(subparacols)` BNF subparagraph codes with COVID-19 in those without listed conditions.  Supplementary Table \ref{tab:subpara.coeffs} shows the univariate rate ratios for the `r length(subparacols.forstepwisedrop)` drug classes that were dispensed to at least 50 cases and controls and were associated with severe disease at $p < 0.001$.  These COVID-19-associated drug classes include widely-prescribed cardiovascular drugs and also multiple drug classes previously identified in Scotland as indicators of overprescribing: laxatives, proton pump inhibitors, hypnotics, anxiolytics, antidepressants, analgesics and nutritional supplements.  A backward stepwise variable elimination procedure as described above was carried out to identify which of these `r length(subparacols.forstepwisedrop)` drug classes contributed most to the association of COVID-19 with polypharmacy.  Figure \ref{fig:stepwise} shows how the log-likelihood changed as these variables were dropped from the model. Dropping the first `r firstrow.neg - 1` drug classes increased the log-likelihood of the model.  Only for the last `r length(rows.print)` drug classes did the log-likelihood decrease when the variable was dropped.  The last drug classes retained by backward selection, and thus the variables with largest independent explanatory power for the effect of polypharmacy, were proton pump inhibitors and "nonopioid analgesics and compound preparations" (BNF subparagraph code 0407010).  

The items grouped under subparagraph 0407010 include opiate-containing compound preparations and also aspirin-containing preparations with which proton pump inhibitors are commonly co-prescribed. To examine the associations with these drug classes in more depth, the total dispensed daily dose of opiate as MME, summed over subparagraphs 0407010 and 0407020 (opiate analgesics) was calculated.  The total dispensed daily dose of proton pump inhibitors was calculated as DDDs.  Distinguishing between causality and confounding is challenging because opiate-containing drugs and proton pump inhibitores are usually co-prescribed with other drugs.  We used several approaches:

* Testing for a dose-response relationship and stratifying by age group

* Adjusting for prespecified covariates and restricting the analysis to those without any  listed condition. 

* Comparison between recent (last 120 days of observation) and less recent (1 June 2019 to 121 days before exposure) time windows of dispensing. 

## Associations with opiate use
Table \ref{tab:dosegr} shows the relationship of severe COVID-19 to average daily opiate dose (MMEs) over the observation period.  This showed a dose-response relationship, strongest in those aged less than 75 years.  With unexposed as baseline, the univariate rate ratio in this age group was `r table.dosegr.opiate["0-74 years: >50", 4]` in those with average daily dose of more than 50 mg morphine equivalent (MME), reduced to `r table.dosegr.opiate["0-74 years: >50", 6]` on adjusting for care home residence, SIMD quintile and any history of neoplasm. In those without any listed condition (all age groups combined), the unadjusted and adjusted rate ratios associated with more than 50 MME /day were `r table.dosegr.opiate.notlisted[">50", 4]` and `r table.dosegr.opiate.notlisted[">50", 6]` respectively. Table \ref{tab:timewindow} shows that the rate ratio associated with opiate dispensing only in the most recent 120-day time window was higher than that associated with dispensing only in a less recent time window (from 1 June 2019 to 121 days before the specimen date)

## Associations with proton pump inhibitor use
Table \ref{tab:dosegr} shows that in those aged under 75 years the rate ratio for severe COVID-19 increases with the dose of proton pump inhibitor.  The univariate rate ratio associated with average dose of 2 or more DDDs / day was `r table.dosegr.protonpump["0-74 years: 2 or more", 4]`, reduced to `r table.dosegr.protonpump["0-74 years: 2 or more", 6]` by adjusting for care home residence, SIMD quintile, any diagnosis of ICD-10 codes K20-K31 (diseases of esophagus, stomach and duodenum), non-steroidal anti-inflammatory drugs, anti-platelet agents and anticoagulants.  This dose-response relationship was absent in those aged 75 years and over.  In those without any listed condition (all age groups combined), the unadjusted and adjusted rate ratios associated with more than 2 DDDs/day MME /day were `r table.dosegr.protonpump.notlisted["2 or more", 4]` and `r table.dosegr.protonpump.notlisted["2 or more", 6]` respectively. Table \ref{tab:timewindow} shows that the rate ratio associated with dispensing of a proton pump inhibitor only in the most recent 120-day time window was higher than the rate ratio associated with dispensing only in a less recent time window. 

## Associations with other drug classes
Supplementary Tables \ref{tab:bnfchapter1}, \ref{tab:bnfchapter2}, \ref{tab:bnfchapter4} and \ref{tab:bnfchapter10} show associations with drug classes in BNF chapters 1 (gastrointestinal) 2 (cardiovascular), 4 (nervous system) and 10 (musculoskeletal).  These chapters were selected as of interest because many drugs in these chapters were associated with COVID-19 or because hypotheses about possible effects of drugs in these chapters -- ACE inhibitors [@mancia_reninangiotensinaldosterone_2020], anticoagulants [@connors_covid-19_2020], and hydroxychloroquine [@alexander_covid-19_2020]-- have been proposed or discussed.   

Table \ref{tab:bnfchapter1} shows that dispensed prescriptions of most classes of drugs for the gastrointestinal system were associated with severe COVID-19, but only proton pump inhibitors, antimotility and laxatives were strongly and independently associated with disease in a multivariate analysis.  Proton pump inhibitors were prescribed far more commonly than any other drug class in this chapter.  

Table \ref{tab:bnfchapter2} shows associations with drugs for the cardiovascular system. Prescriptions of loop diuretics and anticoagulants were associated with elevated rate ratios for severe COVID-19 in univariate and multivariate analyses.  Over all age groups combined, the univariate rate ratio associated with oral anticoagulants was reduced from `r table.bnfchapter2[grep("Oral anticoagulants", rownames(table.bnfchapter2)), 3]` to `r or.ci(coeff.anticoagulant.adjusted[1], coeff.anticoagulant.adjusted[3])` by adjustment for ischaemic heart disese, other heart disease and ever-use of a proton pump inhibitor.  Of drug classes commonly used to treat hypertension, ACE inhibitors and angiotensin II receptor antagonists were associated with reduced risk of COVID-19.  

Table \ref{tab:bnfchapter4} shows that the strongest associations of COVID-19 with drugs for the nervous system were with antipsychotics, analgesics and drugs for dementia.  Table \ref{tab:bnfchapter10} shows associations with drugs for the musculoskeletal system disaggregated by generic name, as the BNF groups all disease-modifying antirheumatic drugs under a single subparagraph code. All antirheumatic drugs were associated with elevated rate ratios for COVID-19.  The univariate rate ratio associated with hydroxychloroquine sulfate was `r table.bnfchapter10[grep("Hydroxychloroquine", rownames(table.bnfchapter10)), 3]`; adjustment for ever-use of a proton pump inhibitor reduced this to `r or.ci(coeff.hydroxychlor.adjusted[1], coeff.hydroxychlor.adjusted[3])`.  

# Discussion 
We have shown that severe COVID-19 is associated with polypharmacy, defined by the number of drugs classes dispensed during the period of observation, in individuals without conditions designated as conferring high risk.  The rate ratios of 5 to 7 associated with dispensing of more than 10 drug classes are larger than the ratio of about 2 for all-cause mortality associated with this level of polypharmacy in a systematic review [@leelakanok_association_2017]. We attempted to investigate how much of this association is likely to be attributable to confounding by multimorbidity and frailty, and how much might be attributable to adverse effects of specific drugs.  A limitation of this study is that we do not have morbidity data from primary care, which would include risk factors such as smoking and coding of presenting complaints.  Strengths of this study are that diagnoses are based on hospital discharge records coded to ICD-10, and that drug exposure is based on dispensed rather than issued prescriptions.  

The drug classes that are strongly associated with severe COVID-19 include proton pump inhibitors and analgesics, widely recognized to be indicators of overprescribing as in the Scottish National Therapeutic Index of prescribing quality [@macbride-stewart_national_2019]. As these are among the most commonly prescribed drug classes, it is to be expected that they are selected by elimination as having the largest independent contributions to the association of COVID-19 with polypharmacy. Distinguishing between causality and confounding as possible explanations for the association of COVID-19 with these drug classes is difficult because drug exposures are not measured accurately, and the associations are likely to be confounded by other drugs, by co-morbidities and more generally by frailty and socioeconomic deprivation. Because proton pump inhibitors are available over the counter, dispensed prescriptions do not capture all exposure. 

For both opiates and proton pump inhibitors, four criteria provide moderate but not conclusive evidence favouring causal explanations over confounding.  There are strong dose-response relationships of COVID-19 to dispensed average daily dose.  Adjustment for covariates pre-specified as likely to confound these associations reduces the effect size only slightly. The effect sizes are larger in younger individuals and when the analysis is restricted to those without any of the designated risk conditions for COVID-19.  Among ever-exposed individuals, the rate ratios associated with dispensing only in the most recent time window were higher than the rate ratios associated with dispensing only in an earlier time window. It may be relevant to investigate these associations in other countries where COVID-19 epidemics have been especially severe and overprescribing of proton pump inhibitors [@luo_changes_2018; @pasina_overuse_2020; @ramirez_overuse_2010] or opiates has been reported previously. 

The dose-response relationship of opiate use to COVID-19 is similar in magnitude to that reported for community-acquired pneumonia in a study of people receiving medical care through the Veterans Administration from 2000-2012 [@edelman_association_2019].  As SARS-CoV-2 is at least partly an enteric infection [@wan_enteric_2020] and the ACE2 receptor is expressed in the intestine, it is plausible that proton pump inhibitors could increase susceptibility to severe infection.  

We emphasize that because of the relationship of COVID-19 to polypharmacy, associations with specific drug classes cannot be studied without taking into account how those drug classes are related to the profile of drug prescribing. For ACE inhibitors and angiotensin-II receptor blockers, our results are consistent with other studies that have found no increased risk associated with these drugs [@mancia_reninangiotensinaldosterone_2020].  The relation of anticoagulant use to COVID-19 is of interest because coagulopathy is a feature of severe disease [@connors_covid-19_2020].  Although in this study anticoagulants were associated with increased risk in univariate analysis, this association was was markedly reduced by adjusting for covariates including diagnosed heart disease and co-prescribing of proton pump inhibitors.  The numbers of cases and controls exposed to hydroxychloroquine in this dataset were too small for associations of severe COVID-19 with this drug to be estimated reliably. 

## Conclusion
Severe COVID-19 is strongly associated with polypharmacy. This association is not easily explained by co-morbidity, and it is strongest in those without hospital diagnoses of conditions that confer high risk of disease.  The profile of drug prescribing associated with COVID-19 includes many drug classes that are indicators of overprescribing, althoug proton pump inhibitors and analgesics have the greatest explanatory power for the association of COVID-19 with polypharmacy.  Although this study did not identify unequivocal evidence of causality for opiates and proton pump inhibitors, effects of these drug classes on susceptibility to COVID-19 are biologically plausible.  We recommend that public health agencies should reinforce existing guidelines on the overprescribing of these drug classes, and more generally on the avoidance of unnecessary polypharmacy.  

# Declarations
## Information governance
This study was conducted under approvals from the [Public Benefit and Privacy Panel for Health and Social Care](https://www.informationgovernance.scot.nhs.uk/pbpphsc/) that allow Public Health Scotland staff to link datasets.  Datasets were de-identified before analysis.  The study protocol was registered with the European Network of Centres for Pharmacoepidemiology and Pharmacovigilance (ENCEPP number [EUPAS35558](http://www.encepp.eu/encepp/viewResource.htm?id=35559)). All source code used for derivation of variables, statistical analysis and generation of this manuscript is available on [GitHub](https://github.com/pmckeigue/covid-scotland_public).  Requests for acccess to the data may be submitted to the Public Benefit and Privacy Panel.  

## Conflicts of interest
HC receives research support and honoraria and is a member of advisory panels or speaker’s bureaus for Sanofi Aventis, Regeneron, Novartis, Novo-Nordisk and Eli Lilly. HC receives or has recently received non-binding research support from AstraZeneca and Novo-Nordisk.  HC and PM own stock in Roche and Bayer.  SH received honoraria from Gilead. 

## Acknowledgements
We thank all staff in critical care units who submitted data to the SICSAG database, the Scottish Morbidity Record Data Team, the staff of the National Register of Scotland, the Public Health Scotland Terminology Services, the HPS COVID-19 Laboratory & Testing cell and the NHS Scotland Diagnostic Virology Laboratories, and Nicola Rowan (HPS) for coordinating this collaboration. 

## Public Health Scotland COVID-19 Health Protection Study Group
Alice Whettlock$^1$, Allan McLeod$^1$, Andrew Gasiorowski$^1$, Andrew Merrick$^1$, Andy McAuley$^1$, April Went$^1$, Calum Purdie$^1$, Colin Fischbacher$^1$, Colin Ramsay$^1$, David Bailey$^1$, David Henderson$^1$, Diogo Marques$^1$, Eisin McDonald$^1$, Genna Drennan$^1$, Graeme Gowans$^1$, Graeme Reid$^1$, Heather Murdoch$^1$, Jade Carruthers$^1$, Janet Fleming$^1$, Jade Carruthers$^1$, Joseph Jasperse$^1$, Josie Murray$^1$, Karen Heatlie$^1$, Lindsay Mathie$^1$, Lorraine Donaldson$^1$, Martin Paton$^1$, Martin Reid$^1$, Melissa Llano$^1$, Michelle Murphy-Hall$^1$, Paul Smith$^1$, Ros Hall$^1$, Ross Cameron$^1$, Susan Brownlie$^1$, Adam Gaffney$^2$, Aynsley Milne$^2$, Christopher Sullivan$^2$, Edward McArdle$^2$, Elaine Glass$^2$, Johanna Young$^2$, William Malcolm$^2$, Jodie McCoubrey $^2$

1  Health Protection Scotland (Public Health Scotland), Meridian Court, 5 Cadogan Street, Glasgow G2 6QE. 

2  NHS National Services Scotland, Meridian Court, 5 Cadogan Street, Glasgow G2 6QE. 

## Supplementary material
The R and Rmarkdown scripts used to generate this article, which include the code used to derive variables, will be made available with this manuscript. 

# References {-}

<div id="refs"></div>

\newpage

```{r stepwise, echo=FALSE, warning=FALSE, message=FALSE, fig.height=6, out.width = "0.99\\textwidth", fig.cap="Stepwise dropping of drug classes from the polypharmacy variable: each row shows the log-likelihood of a conditional logistic regression of severe COVID-19 on care home and polypharmacy as covariates when that drug class is dropped, in  those without listed conditions."}

stepwise.asfactor <- stepwise.drop.subparas
stepwise.asfactor$name <- gsub("\\.", " ", stepwise.asfactor$name)
stepwise.asfactor$numrow <- nrow(stepwise.asfactor):1
stepwise.asfactor$name <- factor(stepwise.asfactor$name, levels=rev(stepwise.asfactor$name))

p.loglik <- ggplot(data=stepwise.asfactor, 
                   aes(x=loglik.full, y=name)) + geom_bar(stat="identity", fill="gray") +
    xlab("Log-likelihood")  +
    theme(axis.title.y=element_blank())
#          axis.text.y=element_blank())

p.coeff <- ggplot(data=stepwise.asfactor, 
                  aes(x=beta.full, y=name)) + geom_bar(stat="identity", fill="gray") +
    xlab("Coefficient (log rate ratio)")

# gridExtra::grid.arrange(p.coeff, p.loglik, nrow=1, widths=c(0.5, 0.4))
p.loglik

if(FALSE) {
knitr::kable(stepwise.drop.subparas[rows.print, ], 
             escape=FALSE, 
             booktabs=TRUE,
             label="stepwise.subparas",
             row.names=FALSE,
             col.names=c("Dropped drug class", "Log rate ratio before dropping",
                         "Log-likelihood of model when dropped"), 
             digits=c(0, 2, 1), 
             caption=paste("Stepwise dropping of drug classes from the polypharmacy variable: dataset restricted to those not resident in care homes and without a listed condition")) %>%
    column_spec(column=1, width="8cm") %>%
    column_spec(column=2, width="2cm") %>%
    column_spec(column=3, width="2cm") %>%
    kable_styling(latex_options="hold_position")
}            
```

\newpage

```{r numdrugs.listed.any, echo=FALSE, warning=FALSE, message=FALSE}

freqs <- with(cc.severe, table(listed.any, CASE))

knitr::kable(table.numdrugsgr.listed.any,
             escape=FALSE,
             booktabs=TRUE,
             label="numdrugs.listed.any",
             row.names=FALSE,
             col.names=c("Number of drug classes", colnames(table.numdrugsgr.listed.any)[2:3], 
                         "Rate ratio (95\\% CI)", "$p$-value"),
             caption="Association of severe COVID-19 with polypharmacy, by diagnosis of at least one listed condition") %>%
    column_spec(column=1, width="2cm") %>%
    kableExtra::group_rows(paste0("No listed condition (",
                      freqs[1, 1], " controls, ", freqs[1, 2], " cases)"),
               1, 6) %>%
    kableExtra::group_rows(paste0("Listed condition (",
                      freqs[2, 1], " controls, ", freqs[2, 2], " cases)"),
               7, 12) %>%
    kable_styling(latex_options="hold_position")

```

```{r dosegr, echo=FALSE, warning=FALSE, message=FALSE}

colnames(table.dosegr.protonpump) <- colnames(table.dosegr.opiate)
table.dosegr <- rbind(table.dosegr.opiate, table.dosegr.protonpump)

knitr::kable(table.dosegr,
             escape=FALSE,
             label="dosegr", 
             booktabs=TRUE,
             row.names=FALSE, # dose levels in column 1
             col.names=c("Average dose", colnames(table.dosegr.opiate)[2:3], 
                         "Rate ratio (95\\% CI)", "$p$-value",
                         "Rate ratio (95\\% CI)", "$p$-value"),
             caption="Associations of severe COVID-19 with dispensed average daily dose of opiates and proton pump inhibitors, with and without adjustment for prespecified covariates") %>%
    add_header_above(c(" "=3, "Univariate"=2, "Adjusted for covariates"=2)) %>%
	column_spec(column=1, width="3cm") %>%
    kable_styling(latex_options="hold_position") %>%
    kableExtra::group_rows(group_label="Opiate-containing analgesics (mg morphine equivalent / day)", 1, 8) %>%
    kableExtra::group_rows(group_label="Proton pump inhibitors (defined daily doses / day)", 9, 18) %>%
    kableExtra::group_rows("  Ages 0-74 years", 1, 4) %>%
    kableExtra::group_rows("  Ages 75+ years", 5, 8) %>%
    kableExtra::group_rows("  Ages 0-74 years", 9, 13) %>%
    kableExtra::group_rows("  Ages 75+ years", 14, 18) %>%
    landscape()

```


```{r timewin, echo=FALSE, warning=FALSE, message=FALSE}

colnames(table.timewindow.opiate) <- colnames(table.timewindow.protonpump)
table.timewindow <- rbind(table.timewindow.opiate, table.timewindow.protonpump)
table.timewindow <- data.frame(timewin=rep(rownames(table.timewindow.opiate), 2),
                               table.timewindow)

knitr::kable(table.timewindow,
             escape=FALSE,
             label="timewindow", 
             booktabs=TRUE,
             row.names=FALSE, 
             col.names=c("Time window", clean.header(colnames(table.timewindow.protonpump)[1:2]), 
                         "Rate ratio (95\\% CI)", "$p$-value"),
             caption=paste0("Associations of severe disease with dispensed prescriptions by ", TW, "-day time window")) %>%
	column_spec(column=1, width="3cm") %>%
	column_spec(column=2:3, width="2cm") %>%
	column_spec(column=4, width="2.5cm") %>%
	column_spec(column=5, width="1.5cm") %>%
    kable_styling(latex_options="hold_position") %>%
    kableExtra::group_rows(group_label="Opiate-containing analgesics (restricted to those without history of neoplasm)", 1, 4) %>%
    kableExtra::group_rows(group_label="Proton pump inhibitors", 5, 8)
```

\newpage
\beginsupplement

# Supplementary Tables


```{r subpara.coeffs, echo=FALSE, warning=FALSE, message=FALSE}

newch <- diff(as.integer(substr(subpara.coeffs$subpara, 1, 1))) !=0
linesep <- ifelse(newch, '\\addlinespace', '')
                  
knitr::kable(subpara.coeffs,
             escape=FALSE,
             longtable=TRUE, 
             booktabs=TRUE,
             linesep = linesep, 
             label="subpara.coeffs",
             row.names=FALSE,
col.names=c("BNF subparagraph", colnames(subpara.coeffs)[2:3],  
            "Rate ratio", "$p$-value"),
             caption=paste("Univariate rate ratios for severe COVID-19 associated with dispensing of each BNF subparagraph code in those without a listed condition, filtered to show only drug classes with at least 50 exposed individuals and  $p < 0.001$: ")) %>%
    column_spec(column=1, width="10cm") %>%
    column_spec(column=2, width="1.5cm") %>%
    column_spec(column=3, width="1.5cm") %>%
    kable_styling(latex_options="hold_position") %>%
    landscape()
            
```

```{r bnfchapter1, echo=FALSE, warning=FALSE, message=FALSE}

knitr::kable(table.bnfchapter1,
             escape=FALSE, 
             booktabs=TRUE,
             label="bnfchapter1",
             col.names=c(clean.header(colnames(table.bnfchapter1)[1:2]),
                         "Rate ratio (95\\% CI)", "$p$-value",
                         "Rate ratio (95\\% CI)", "$p$-value"),
             align=rep("c", 6), 
             caption="Associations of severe COVID-19 with prescribed drugs in BNF chapter 1 by subparagraph code in those aged under 75 years, filtered to retain rows with at least 50 exposed individuals") %>%
    column_spec(column=1, width="4cm") %>%
    add_header_above(c(" "=3, "Univariate"=2, "Multivariate"=2)) %>%
    kable_styling(latex_options="hold_position") %>%
    landscape()
```


```{r bnfchapter2, echo=FALSE, warning=FALSE, message=FALSE}

knitr::kable(table.bnfchapter2,
             escape=FALSE, 
             booktabs=TRUE,
             label="bnfchapter2",
             col.names=c(clean.header(colnames(table.bnfchapter2)[1:2]),
                         "Rate ratio (95\\% CI)", "$p$-value",
                         "Rate ratio (95\\% CI)", "$p$-value"),
             align=rep("c", 6), 
             caption="Associations of severe COVID-19 with prescribed drugs in BNF chapter 2 by subparagraph code in those aged under 75 years, filtered to retain rows with at least 50 exposed individuals") %>%
    column_spec(column=1, width="4cm") %>%
    add_header_above(c(" "=3, "Univariate"=2, "Multivariate"=2)) %>%
    kable_styling(latex_options="hold_position") %>%
    landscape()
```

```{r bnfchapter4, echo=FALSE, warning=FALSE, message=FALSE}

knitr::kable(table.bnfchapter4,
             escape=FALSE, 
             booktabs=TRUE,
             label="bnfchapter4",
             col.names=c(clean.header(colnames(table.bnfchapter4)[1:2]),
                         "Rate ratio (95\\% CI)", "$p$-value",
                         "Rate ratio (95\\% CI)", "$p$-value"),
             align=rep("c", 6), 
             caption="Associations of severe COVID-19 with prescribed drugs in BNF chapter 4  by subparagraph code in those aged under 75 years, filtered to retain rows with at least 50 exposed individuals") %>%
    column_spec(column=1, width="4cm") %>%
    add_header_above(c(" "=3, "Univariate"=2, "Multivariate"=2)) %>%
    kable_styling(latex_options="hold_position") %>%
    landscape()
```

```{r bnfchapter10, echo=FALSE, warning=FALSE, message=FALSE}
	

rownames(table.bnfchapter10) <- tolower.exceptfirstchar(rownames(table.bnfchapter10))
rownames(table.bnfchapter10) <- gsub("\\.", " ", rownames(table.bnfchapter10))

knitr::kable(table.bnfchapter10,
             escape=FALSE, 
             booktabs=TRUE,
             label="bnfchapter10",
             col.names=c(clean.header(colnames(table.bnfchapter10)[1:2]),
                         "Rate ratio (95\\% CI)", "$p$-value",
                         "Rate ratio (95\\% CI)", "$p$-value"),
             align=rep("c", 6), 
             caption="Associations of severe COVID-19 with prescribed drugs in BNF chapter 10 by approved name in those aged under 75 years, filtered to retain rows with at least 50 exposed individuals") %>%
    column_spec(column=1, width="5cm") %>%
    add_header_above(c(" "=3, "Univariate"=2, "Multivariate"=2)) %>%
    kable_styling(latex_options="hold_position") %>%
    landscape()
``````

