---
title: "Variation in efficacy of COVID-19 vaccination against severe COVID-19 by clinical vulnerability status: the REACT-SCOT case-control study"
author:
  - name: Paul M McKeigue\textsuperscript{\getAff{Usher}}
    affiliation: HPS
    corresponding: yes
    email: paul.mckeigue@ed.ac.uk
  - name: David A McAllister\textsuperscript{\getAff{Glasgow}} 
    affiliation: HPS 
  - name: Chris Robertson\textsuperscript{\getAff{Strathclyde}} 
    affiliation: HPS
  - name: Helen M Colhoun\textsuperscript{\getAff{IGMM}}
    affiliation: HPS
  - name: for the PHS COVID-19 Epidemiology and Research Cell
    affiliation: HPS
address: 
- code: Usher
  address: Usher Institute, College of Medicine and Veterinary Medicine, University of Edinburgh, Teviot Place, Edinburgh EH8 9AG, Scotland. 
- code: IGMM
  address: Institute of Genetics and Cancer, College of Medicine and Veterinary Medicine, University of Edinburgh, Western General Hospital Campus, Crewe Road, Edinburgh EH4 2XUC, Scotland. 
- code: HPS
  address: Public Health Scotland, Meridian Court, 5 Cadogan Street, Glasgow G2 6QE
- code: Glasgow
  address: Institute of Health and Wellbeing, University of Glasgow, 1 Lilybank Gardens, Glasgow G12 8RZ. 
- code: Strathclyde
  address: Department of Mathematics and Statistics, University of Strathclyde, 16 Richmond Street, Glasgow G1 1XQ.

header-includes:
  \usepackage{newunicodechar}
  \usepackage[T1]{fontenc}
  \let\origquote\quote
  \def\quote{\origquote\itshape}
  \usepackage{graphicx}
  \usepackage{geometry}
  \usepackage{longtable}
  \usepackage{booktabs}
  \usepackage{float}
  \floatplacement{figure}{H}
  \usepackage{array}
  \usepackage{threeparttable}
  \usepackage{longtable}
output: 
  rticles::nejm_article:
    includes:
      in_header: ./preamble.tex
    latex_engine: lualatex
    keep_tex: true
    fig_caption: yes
    md_extensions: -autolink_bare_uris
geometry: "left=2cm,right=2cm,top=2cm,bottom=2cm"
bibliography: ./covid.bib
csl: ./f1000.csl # ./plos.csl
always_allow_html: true
urlcolor: blue
linenumbers: false
linkcolor: cyan 
---

```{r vax, echo=FALSE, warning=FALSE, message=FALSE}
library(kableExtra)

options(knitr.kable.NA = '.')
options(knitr.table.format = "latex") # adds tab: prefix to labels
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)

```
\newpage

# Abstract 

**Objectives** - To determine whether COVID-19 efficacy varies with clinical risk category and to investigate risk factors for severe COVID-19 in those who have received two doses of vaccine.  

**Design** - Matched case-control study (REACT-SCOT).  

**Setting** - Population of Scotland from 1 December 2020 to 28 July 2021. 

**Main outcome measure** - Severe COVID-19, defined as cases with entry to critical care or  fatal outcome.  

**Results** - Efficacy against severe COVID-19 of two doses of vaccine was `r pctefficacy.or.ci(table.riskgr[effect=="No risk condition: vax dose 2", rateratio])` in those without designated risk conditions, `r pctefficacy.or.ci(table.riskgr[effect=="Moderate risk condition: vax dose 2", rateratio])` in those with moderate risk conditions, but only `r pctefficacy.or.ci(table.riskgr[effect=="Eligible for shielding: vax dose 2", rateratio])` in those designated as clinically extremely vulnerable (CEV) and eligible for shielding.  Efficacy of two doses against severe COVID-19 in the CEV group did not differ between the AstraZeneca vaccine (`r pctefficacy.or.ci(table.vaxgr[effect=="Eligible for shielding: 2 doses AZ vaccine", rateratio])`) and the mRNA vaccines (`r pctefficacy.or.ci(table.vaxgr[effect=="Eligible for shielding: 2 doses mRNA vaccine", rateratio])`).  Of the 221 cases of severe COVID-19 in double-vaccinated individuals, 44% had moderate risk conditions and 43% were CEV.  In the doubly-vaccinated CEV group, the rate ratio for severe disease (with no risk condition as reference category) was highest in solid organ transplants at `r astext.or.ci(table.severe.vax2["Solid organ transplant", 3])` but even in this subgroup the absolute risk of severe COVID-19 in the double-vaccinated was low (12 cases in 14386 person-months of follow-up).  

**Conclusions** - 
Two doses of vaccine protect against severe COVID-19 in clinically extremely vulnerable persons but the efficacy is somewhat lower than in those who are not CEV.  These results support a policy of offering booster doses to doubly-vaccinated vulnerable individuals, who can be identified from their health records.  

\newpage

# Introduction
The REACT-SCOT matched case-control study was established at the beginning of the epidemic to investigate risk factors for severe COVID-19 in the population of Scotland [@mckeigue_rapid_2020].  Using this framework, we have reported in detail on the relation of severe COVID-19 to risk factors including designated moderate risk conditions, drug prescribing and those designated as clinically extremely vulnerable (CEV) and therefore eligible for shielding [@mckeigue_rapid_2020;@mckeigue_relation_2021a;@mckeigue_relation_2021b].  

We have previously reported an initial comparison of the efficacy of vaccination against severe COVID-19 between CEV people and those with moderate risk conditions or no risk conditions, based on data up to 16 March 2021 [@mckeigue_efficacy_2021].   At this time few individuals had received a second dose of vaccine, but since then most CEV individuals have received two doses. This report updates and extends the earlier analyses, with the following objectives: 

1. To determine whether vaccine efficacy varies with risk category and CEV status now that more data, including exposure to two doses of vaccine, are available  and now that the delta variant is the dominant variant in Scotland.

2. To investigate risk factors for severe or hospitalised COVID-19 in those who have received two doses of vaccine.  

In an accompanying report we have investigated how efficacy of vaccination against severe COVID-19 changed with the appearance of the Delta variant and how  efficacy of two doses varies with time since second dose.  

# Methods 
We used the REACT-SCOT study to take advantage of data linkages already established. The design has been described in detail previously [@mckeigue_rapid_2020]. In brief, for every incident case of COVID-19 in the population ten controls matched for one-year age, sex and primary care practice and alive on the day of presentation of the case that they were matched to were selected using the Community Health Index database.  COVID-19 cases are those with a positive nucleic acid test, or a hospital admission or death with COVID-19 ICD-10 codes. The REACT-SCOT case-control dataset is refreshed regularly and is linked to the vaccination database and to the regularly updated dataset of all individuals deemed eligible for the shielding programme.  This analysis is based on cases presenting from 1 December 2020 to 14 July 2021, so that we have at least 14 days of follow-up for each case.  This allows case severity status (hospitalisation, entry to critical care or death) to be assigned. 

## Classification of risk categories
As previously [@mckeigue_rapid_2020], to minimise ascertainment bias we pre-specified the primary outcome measure as severe COVID-19,  defined as diagnosed cases with entry to critical care within 28 days of presentation or fatal outcome (any death within 28 days of a positive test or any death for which COVID-19 was coded as underlying cause).  Cases and controls were classified into three broad risk categories: no risk condition; at least one of the moderate risk conditions designated by public health agencies [@mckeigue_rapid_2020]; or eligible for shielding [@mckeigue_relation_2021b].  For further analyses, the shielding category was subdivided as described previously  into six categories: solid organ transplant, specific cancers, severe respiratory conditions, other rare conditions, on immunosuppressants, and additional conditions [@mckeigue_relation_2021b].   This corresponds to the list used by Public Health Scotland  [@health_protection_scotland_search_2020], after combining the small numbers in the group "pregnant with heart disease with the "other conditions" category.  For additional analyses the category "specific cancers" was split to allocate cancers of blood-forming organs (ICD-10 codes C81-C88, C90-C96) to a separate category.  

## Statistical analysis
Vaccination status was coded as the number of doses administered at least 14 days before presentation date. Vaccine doses administered less than 14 days before presentation date are ignored.  For estimates of effect by risk category, where the numbers of events are large, vaccination status was modelled as a factor comparing 1 dose or 2 doses with 0 doses as reference category.  For estimates of effect within shielding eligibility groups where the numbers of events in each category are smaller, vaccination status was modelled as a numeric variable taking values \ensuremath{0, \frac{1}{2}, 1}  so that the effect parameter represents the rate ratio associated with 2 doses assuming the effect of 0, 1, 2 doses to be linear on the scale of the log rate ratio. 

Covariates included in the models were those that have been previously identified as strong predictors of severe disease in this population: care home residence, number of adults in household, number of non-cardiovascular drug classes dispensed and recent hospital stay [@mckeigue_rapid_2020;@mckeigue_relation_2021a;@mckeigue_relation_2021b].  For care home residents the number of of adults in the household was coded as 1 to ensure that these two variables are not confounded.  The number of non-cardiovascular drug classes was calculated as the number of distinct BNF subparagraph codes for which a prescription was dispensed between 15 and 240 days before presentation date.  The number of hospital diagnoses was calculated as the number of distinct ICD-10 chapters represented at least once in hospital discharge records between 25 days and 5 years before presentation date. Recent hospital stay was defined as any in-patient stay from 5 to 14 days before presentation date.

The effect of vaccination in each of the clinical vulnerability categories was estimated in a conditional logistic regression model specifying effects \ensuremath{\beta_{R2}, \dots, \beta_{RJ}} for the log rate ratio associated with risk categories 2 to \ensuremath{J} (\ensuremath{\beta_{R1} = 0} for the reference category \ensuremath{J=1}), and nested effects \ensuremath{\beta_{V1}, \dots, \beta_{VJ}} for the log rate ratio associated with vaccination in each of the \ensuremath{J} risk categories. With this incidence density sampling design, the conditional odds ratio is the rate ratio.  The efficacy of vaccination is 1 minus the rate ratio.   The design controls not only for the matching factors of age, sex and general practice but also for calendar time.  The unconditional odds ratios calculated from frequency tables of the vaccination status of cases and controls in each risk group cannot be used to estimate rate ratios [@breslow_estimation_1978;@greenland_need_1982].   

# Cohort analysis of the shielding list
The case-control study estimates only rate ratios.  To investigate  how the absolute rates of severe disease in those listed as clinically extremely vulnerable  have changed with the vaccination programme rollout, we  also undertook a cohort analysis of all individuals who had ever been on the shielding/ CEV list.  A Poisson regression model was fitted to the cohort formatted with one observation per 28-day person-time interval, and individuals censored at first diagnosis of COVID-19.  Event status was defined as severe COVID-19 presenting within the person-time interval, and the covariates were sex, baseline age, and shielding eligibility group.  The baseline hazard rate was modelled as a natural spline function of calendar time with 6 degrees of freedom. Similar models were fitted with event status defined as any diagnosed case.  

# Results
## Relation of vaccine efficacy to risk conditions
As shown in Table \ref{tab:freqsvaxgr} between 1 December 2020 to 14 July 2021  there were 4992 cases of severe COVID-19 in the total population of Scotland of whom 27% had no designated risk condition, 53%  had a moderate risk condition and 20%  were CEV.  The distributions in cases and controls  of other risk factors included as covariates in the models are shown for completeness.   Overall 86% of severe cases arising in this period were not yet vaccinated.   Table \ref{tab:hospfreqsvaxgr} shows the same tabulation with case definition broadened to include all hospitalised cases and their matched controls. 

Table \ref{tab:rateratiosriskgroups} shows rate ratios associated with 1 and 2 vaccine doses (with 0 doses as reference category) in each of the three broad risk categories  from the conditional logistic regression model.  The  model included risk categories (no risk conditions as reference category),  care home residence, number of adults in household, number of drug classes and recent hospital stay as covariates. The rate ratio associated with two doses of vaccine was `r format.estci(table.riskgr[effect=="No risk condition: vax dose 2", rateratio])` in those without risk conditions, `r format.estci(table.riskgr[effect=="Moderate risk condition: vax dose 2", rateratio])` in those with moderate risk conditions, and `r format.estci(table.riskgr[effect=="Eligible for shielding: vax dose 2", rateratio])` in those eligible for shielding (i.e. CEV).  On the scale of efficacy, these estimates are equivalent to 94% in those without risk conditions, 91% in those with risk conditions, and 68% in those eligible for shielding.  <!---To test formally for an effect of risk category on vaccine efficacy, a model was fitted with interaction terms for  risk category \ensuremath{\times} times vaccine dose.  In those with 2 doses, the effect (on the scale of rate ratio) of eligibility for shielding (with no risk condition as reference category) on the rate ratio associated with 2 doses of vaccine (0 doses as reference category) was `r format.estci(vaxriskgr.interaction)`.  ---> 
Table \ref{tab:hosprateratiosriskgroups} shows the same model with case definition broadened to include all hospitalised cases and their matched controls: the efficacy of 2 doses  against hospitalisation  was also lower in those eligible for shielding than in the other two risk categories.  

As the estimates of efficacy for a single dose in Table \ref{tab:rateratiosriskgroups} for this entire period  of 1 Dec 2020 up to 14 July 2021 differ from those we reported  previously based only on data up to 16 March 2021 [@mckeigue_efficacy_2021], we examined whether our earlier results were reproduced in this updated dataset.  Restricting the dataset to exclude cases and controls sampled after 16 March 2021, the point estimates of the rate ratios associated with one dose of vaccine in the same model for those with no risk conditions, moderate risk conditions and eligible for shielding were 0.28, 0.25 and 0.31 respectively,  very similar to the estimates previously reported with slightly different covariate adjustment and less complete follow-up of outcome in cases after presentation date [@mckeigue_efficacy_2021]    

<!---To exclude the possibility that misclassification of deaths within 28 days of a positive test as deaths from COVID-19 might account for apparently lower vaccine efficacy of vaccines in the CEV group, the analysis was repeated with exclusion of fatal cases where COVID-19 was not certified as the underlying cause of death.  With this restricted case definition, the rate ratio associated with two doses of vaccine was `r format.estci(table.nonfatalorucod[effect=="No risk condition: vax dose 2", rateratio])` in those without risk conditions, `r format.estci(table.nonfatalorucod[effect=="Moderate risk condition: vax dose 2", rateratio])` in those with moderate risk conditions, and `r format.estci(table.nonfatalorucod[effect=="Eligible for shielding: vax dose 2", rateratio])` in those eligible for shielding.  --->

Table \ref{tab:rateratiosshieldgroups} shows rate ratios associated with vaccination by CEV subgroup.  Because the numbers in some CEV subgroups are small, the rate ratios are estimated as linear effects of dose rather than with separate terms for 1 or 2 doses as in analyses where the CEV group is not subdivided.  Rate ratios were higher (and thus efficacy was lower) in all shielding eligibility subgroups than in those without risk conditions or with moderate risk conditions,  but the confidence intervals were too wide for comparisons of efficacy between CEV subgroups.  Table \ref{tab:hosprateratiosshieldgroups} shows  shows rate ratios  for the first and second dose with the case definition broadened to include all hospitalised cases and their matched controls. In this table the highest rate ratio (lowest efficacy) is in solid organ transplant recipients but again the confidence intervals are too wide for comparisons of efficacy between CEV subgroups. 

We examined whether there was any difference in efficacy by class of vaccine and whether any such differences varied by risk category.  Table \ref{tab:rateratiosvaxgroups} shows rate ratios associated with 1 and 2 doses of each class of vaccine (with 0 doses as reference category) in each of the three broad risk categories.  Table \ref{tab:hosprateratiosvaxgroups} shows the same model with case definition broadened to include all hospitalised cases and their matched controls.  Although the confidence intervals for the rate ratios associated with 1 or 2 doses of each vaccine product  in the CEV group are wide, it is clear that the efficacy of 2 doses is lower in the CEV group than in those with moderate risk conditions or no risk conditions.  There was no evidence that efficacy against severe COVID-19 of 2 doses in CEV individuals was lower for the AZ than for the mRNA vaccine, and only weak evidence for lower efficacy of the AZ vaccine against the broader category of hospitalized or fatal COVID-19:  rate ratio 1.51 (95% CI 0.66 to 1.03, _p_=0.04) times higher for the AZ vaccine than for the Pfizer vaccine.   

## Risk factors for severe COVID-19 in the double-vaccinated
Table \ref{tab:severevax2} shows risk factors for severe COVID-19 in cases and controls who had received 2 doses of vaccine at least 14 days before presentation date.  Table \ref{tab:hospvax2} shows the same analysis with case definition broadened to include hospitalized cases and matched controls who had received 2 doses of vaccine. Only 13% of double-vaccinated severe cases had no designated risk condition: 44% had at least one moderate risk condition and 43% were eligible for shielding.    Of the variables that we have previously reported as risk factors for severe COVID-19 in the general population, care home residence and socioeconomic deprivation were not associated with severe disease in the double-vaccinated.  In this group the risk factors for severe disease were designated risk conditions, other indicators of co-morbidity including numbers of hospital diagnoses and drug classes prescribed and transmission-related factors including number of adults in household and recent hospital stay.  A risk score for hospitalised or fatal COVID-19 in the double-vaccinated calculated from the multivariable conditional logistic regression model in Table \ref{tab:hospvax2} was able to classify cases and noncases with a C-statistic of 0.80.  Among the CEV groups, the highest rate ratio for severe disease was solid organ transplant recipients: with no risk conditions as reference category, the unadjusted rate ratio associated with receipt of a solid organ transplant among the double-vaccinated was `r format.estci(table.severe.vax2["Solid organ transplant", 3])` for severe disease and `r format.estci(table.hosp.vax2["Solid organ transplant", 3])` for hospitalisation.  

## Shielding cohort
By the date of the latest extract of the shielding list in July 2021, 8230 (4%) of the 202510 individuals who had ever been on the shielding list had been diagnosed with COVID-19, and 18893 (9%) had been removed from the list for other reasons.  Fig \ref{fig:caseseverity} shows the fitted incidence per month of any diagnosis and of severe cases in Poisson regression models fitted to the entire cohort.   The incidence of any diagnosed COVID-19 in the shielding cohort  fell from 1 December to a nadir in late Aprll.  Despite the incidence of any diagnosed COVID-19 rising steeply from 1 May onwards, the incidence of severe COVID-19 rose only  slightly .   

Fig \ref{fig:plotcases} shows the daily numbers of severe cases (averaged over 3-day sliding windows) by risk category. Table \ref{tab:cohortseverevax2} shows the incidence of severe COVID-19 in doubly-vaccinated CEV individuals, by subgroup.  The incidence in solid organ transplant recipients was 0.8 per 1000 per month (12 cases in 14386 person-months of follow-up). 

# Discussion
## Statement of principal findings
1. Although the efficacy of two doses of vaccine against severe COVID-19 in those without risk conditions remains high (at least 90%), it is now clear that efficacy in clinically extremely vulnerable individuals is somewhat lower.  

2. Among the double-vaccinated, 87% of severe cases and 77% of hospitalised cases have designated risk conditions or are eligible for shielding.   

2. CEV individuals remain at high risk of severe disease even after two doses of vaccine: for solid organ transplant recipients that rate ratio is approximately 70-fold for severe disease and 30-fold for hospitalisation in comparison with double-vaccinated individuals of the same age and sex without risk conditions. However even in this group the absolute risk of severe disease in the double-vaccinated is less than 1 in 1000 per month. 

The explanation for why the differences in efficacy between the CEV group and those without risk conditions have become apparent only after March 2021 is not clear.  We have shown in an accompanying paper that the replacement of the Alpha variant by the Delta variant over a few weeks in May 2021 was accompanied by a decrease in efficacy of vaccination against severe COVID-19, though in the general population this decrease was only temporary. 

## Strengths and limitations
Strengths of this study are the elimination of calendar time effects by the matched case-control design, the comprehensive linkage to e-health records and the focus on severe cases as main outcome measure. Hospitalised cases may include some test-positive individuals whose admission or continued stay in hospital was for another underlying diagnosis: this in turn may lead to underestimation of vaccine efficacy against COVID-19, especially in risk groups with comorbidities.  Such misclassification is less likely to occur with the narrow definition of severe COVID-19 used in the REACT-SCOT study. 

The main limitation  is that no data on hospital prescribing are available and thus we cannot study the relation of risk to different classes of immunosuppressant drugs.   Most immunosuppressants and drugs for cancer are prescribed only in hospital and records are not held in electronic form.  The national shielding list does not hold any information about drug therapy, and no information about diagnoses other than the seven broad categories listed as eligible for shielding.  

## Relation to other studies
A recent report based on primary care data covering 7.2 million people curated by the Royal College of General Practitioners Research and Surveillance Centre examined vaccine efficacy against symptomatic COVID-19 for which a medical consultation was recorded  [@whitaker_pfizerbiontech_2021].  For those who had been advised to shield, the efficacy after two doses of any vaccine was estimated as 92% in those aged less than 65 years and 84% in those aged 65 years and over.  For the "immunocompromised" group the estimated vaccine efficacy was somewhat lower at 74%, with a wide confidence interval. No separate analysis of vaccine efficacy in solid organ transplant recipients was reported.  

## Policy implications. 
As in the general population, two doses are more effective than one in CEV individuals. It is thus plausible that an additional dose might give more protection to double-vaccinated individuals in this group. For identifying those among the double-vaccinated who are at high risk of severe disease and should be offered a booster dose, a multivariable risk score based on electronic health records could easily be constructed, but a simple risk classifier based on presence of designated risk conditions or CEV status would cover 87% of those at risk of severe disease.   

# Declarations
## Ethics approval
This study was performed within Public Health Scotland as part of its statutory duty to monitor and investigate public health problems.  Under the [UK Policy Framework for Health and Social Care Research](https://www.hra.nhs.uk/planning-and-improving-research/policies-standards-legislation/uk-policy-framework-health-social-care-research/) set out by the NHS Health Research Authority, this does not fall within the definition of research and ethical review is not required.  Individual consent is not required for Public Health Scotland staff to process personal data to perform specific tasks in the public interest that fall within its statutory role.  The statutory basis for this is set out in Public Health Scotland's [privacy notice](https://www.publichealthscotland.scot/our-privacy-notice/personal-data-processing/).  

# References
<div id="refs"></div>

\newpage

# Figures

```{r caseseverity, echo=FALSE, warning=FALSE, message=FALSE, fig.pos = "H", fig.width=4, fig.asp=0.8, fig.cap="\\label{fig:caseseverity} Poisson regression model for 60-day incidence of any case and severe case in the shielding cohort"}

theme_set(theme_gray(base_size = 10))

p.anycase

```

# Tables

```{r freqsvaxgroups, echo=FALSE, message=FALSE}

knitr::kable(freqs.vaxgr, 
             escape=FALSE, 
             booktabs=TRUE,
			 label="freqsvaxgr",
             row.names=TRUE, 
			 align=c('r', 'r'), 
             caption="Numbers of controls and cases of severe COVID-19 by risk group and vaccine product") %>%
    add_footnote(label=c("Presentation dates from 1 December 2020 to 14 July 2021.",
                         "Severe COVID-19 defined as entry to critical care or death within 28 days of presentation.", 
                         "Controls matched for age, sex, and primary care practice on date of presentation of case.", 
                         "Vaccination status is number of doses administered at least 14 days before presentation date"), 
                 notation="none") %>%
    kableExtra::group_rows("Risk/shielding eligibility group", 6, 13, bold=FALSE) %>% 
    kableExtra::group_rows("Vaccination status", 14, 18, bold=FALSE) %>% 
    column_spec(1, width="5cm") %>%
    column_spec(2, width="4cm") %>%
    column_spec(3, width="3cm") %>%
   kable_styling(latex_options=c("HOLD_position")) 

```

```{r rateratiosriskgroups, echo=FALSE, message=FALSE}

knitr::kable(table.riskgr[7:12, ], 
             escape=FALSE, 
             booktabs=TRUE,
			 label="rateratiosriskgroups",
             row.names=FALSE,
             col.names=c("Effect", "Rate ratio (95\\% CI)", "\\ensuremath{p}-value"),
			 align=c('l', 'c', 'c'), 
             caption="Rate ratios for severe COVID-19 within risk groups: vaccine dose as categoric variable with unvaccinated as reference category") %>%
    kableExtra::group_rows("No risk condition, unvaccinated as reference category", 1, 2, bold=TRUE) %>% 
    kableExtra::group_rows("Moderate risk condition, unvaccinated as reference category", 3, 4, bold=TRUE)  %>% 
    kableExtra::group_rows("Eligible for shielding, unvaccinated as reference category", 5, 6, bold=TRUE)  %>% 
    add_footnote(label=c("Presentation dates from 1 December 2020 to 14 July 2021.",
                         "Severe COVID-19 defined as entry to critical care or death within 28 days of presentation.", 
                         "Controls matched for age, sex, and primary care practice on date of presentation of case.", 
                         "Adjusted for care home residence, number of adults in household, number of drug classes and recent hospital stay as covariates", 
                     "Rate ratios estimated in multivariable conditional logistic regression with all variables in model",  
                         "Vaccination status is doses administered at least 14 days fbefore presentation date"), 
                 notation="none") %>%
    column_spec(1, width="6cm") %>%
    column_spec(2, width="4cm") %>%
    column_spec(3, width="3cm") %>%
    kable_styling(latex_options=c("HOLD_position")) 

```

```{r rateratiosshieldgroups, echo=FALSE, message=FALSE}

table.shieldgr[, effect := gsub("vax", "vaccine", effect)] 
knitr::kable(table.shieldgr[12:19, ], 
             escape=FALSE, 
             booktabs=TRUE,
			 label="rateratiosshieldgroups",
             row.names=FALSE,
             col.names=c("Effect", "Rate ratio (95\\% CI)", "\\ensuremath{p}-value"),
			 align=c('l', 'c', 'c'), 
             caption="Rate ratios for severe COVID-19 within shielding eligibility groups: vaccine dose encoded as numeric variable taking values 0, 1/2, 1") %>%
add_footnote(label=c("Presentation dates from 1 December 2020 to 14 July 2021.",
                     "Severe COVID-19 defined as entry to critical care or death within 28 days of presentation.", 
                     "Controls matched for age, sex, and primary care practice on date of presentation of case.",
                     "Adjusted for care home residence, number of adults in household, number of drug classes and recent hospital stay as covariates", 
                     "Rate ratios estimated in multivariable conditional logistic regression with all variables in model",  
                     "Vaccination status is number of doses administered at least 14 days before presentation date"), 
             notation="none") %>%
    column_spec(1, width="8cm") %>%
column_spec(2, width="4cm") %>%
column_spec(3, width="3cm") %>%
    kable_styling(latex_options=c("HOLD_position")) 

```

```{r rateratiosvaxgroups, echo=FALSE, message=FALSE}

startrow <- 1
knitr::kable(table.vaxgr[7:18,], 
             escape=FALSE, 
             booktabs=TRUE,
			 label="rateratiosvaxgroups",
             row.names=FALSE,
             col.names=c("Effect", "Rate ratio (95\\% CI)", "\\ensuremath{p}-value"),
			 align=c('l', 'c', 'c'), 
             caption="Rate ratios for severe COVID-19 within risk groups: vaccine dose and product encoded as categoric variable with unvaccinated as reference category") %>%
    kableExtra::group_rows("No risk condition", startrow, startrow+3, bold=TRUE) %>% 
    kableExtra::group_rows("Moderate risk condition", startrow+4, startrow+7, bold=TRUE)  %>% 
    kableExtra::group_rows("Clinically extremely vulnerable", startrow+8, startrow+11, bold=TRUE)  %>% 
add_footnote(label=c("Presentation dates from 1 December 2020 to 14 July 2021.",
                     "Adjusted for care home residence, number of adults in household, number of drug classes dispensed, recent hospital stay and risk category.", 
                     "Controls matched for age, sex, and primary care practice on date of presentation of case.", 
                     "Vaccination status is number of doses administered at least 14 days before presentation date"), 
             notation="none") %>%
    column_spec(1, width="8cm") %>%
column_spec(2, width="4cm") %>%
column_spec(3, width="3cm") %>%
    kable_styling(latex_options=c("HOLD_position")) 

```

```{r severevax2, echo=FALSE, message=FALSE}

knitr::kable(table.severe.vax2, 
             escape=FALSE, 
             booktabs=TRUE,
			 label="severevax2",
             row.names=TRUE, 
            caption="Risk factors for severe COVID-19 in those who had received 2 doses of vaccine at least 14 days before", 
             col.names=c(clean.header(colnames(table.severe.vax2)[1:2]),
                         "Rate ratio (95\\% CI)", "\\ensuremath{p}-value",
                         "Rate ratio (95\\% CI)", "\\ensuremath{p}-value")) %>%
    add_header_above(c(" "=3, "Univariate"=2, "Multivariable"=2)) %>%
    column_spec(column=1, width="4cm") %>%
    column_spec(column=2, width="2cm") %>%
    column_spec(column=3, width="2cm") %>%
    column_spec(column=4, width="3cm") %>%
    column_spec(column=5, width="1.7cm") %>%
    column_spec(column=6, width="2.7cm") %>%
    column_spec(column=7, width="1.7cm") %>%
    kableExtra::group_rows("Shielding eligibility category", 9, 14, bold=FALSE) %>%
   add_footnote(label=c("Severe COVID-19 is defined by entry to critical care or fatal outcome", 
                         "Percentages are column percentages for each variable",
                         "Rate ratios are from conditional logistic regression models matched for age, sex and general practice",
                         "Univariate rate ratios are for models with a single covariate",
                         "Multivariable rate ratios are for a model including all covariates shown in the table"),
                 notation="none") %>%
    kable_styling(latex_options=c("scale_down", "HOLD_position"))

```

# Supplementary Material
\beginsupplement

## Supplementary Figures

```{r plotcases, echo=FALSE, warning=FALSE, message=FALSE, fig.pos = "H", fig.width=6, fig.asp=0.8, fig.cap="\\label{fig:plotcases} Daily severe cases by risk category"}

theme_set(theme_gray(base_size = 10))

p.byelig + theme(legend.title = element_blank()) 

```

```{r plotrateratios, echo=FALSE, warning=FALSE, message=FALSE, fig.pos = "H", fig.width=6, fig.asp=0.8, fig.cap="\\label{fig:plotrateratios} Rate ratios by 42-day sliding window. For each time window, the conditional logistic regression model includes all variables shown in the plot, together with care home residence and recent hospital stay. Line thickness is inversely proportional to standard error"}

theme_set(theme_gray(base_size = 10))
# p.rateratio


```

## Supplementary Tables

```{r hospfreqsvaxgroups, echo=FALSE, message=FALSE}

knitr::kable(freqs.hosp.vaxgr, 
             escape=FALSE, 
             booktabs=TRUE,
			 label="hospfreqsvaxgr",
             row.names=TRUE, 
			 align=c('r', 'r'), 
             caption="Numbers of controls and cases of hospitalized or fatal COVID-19 by risk group and vaccine product") %>%
    add_footnote(label=c("Presentation dates from 1 December 2020 to 14 July 2021.",
                         "Controls matched for age, sex, and primary care practice on date of presentation of case.", 
                         "Vaccination status is number of doses administered at least 14 days before presentation date"), 
                 notation="none") %>%
    kableExtra::group_rows("Risk/shielding eligibility group", 6, 12, bold=FALSE) %>% 
    kableExtra::group_rows("Vaccination status", 14, 18, bold=FALSE) %>% 
    column_spec(1, width="5cm") %>%
    column_spec(2, width="4cm") %>%
    column_spec(3, width="3cm") %>%
   kable_styling(latex_options=c("HOLD_position")) 

```

```{r hosprateratiosriskgroups, echo=FALSE, message=FALSE}

knitr::kable(table.hosp.riskgr[7:12, ], 
             escape=FALSE, 
             booktabs=TRUE,
			 label="hosprateratiosriskgroups",
             row.names=FALSE,
             col.names=c("Effect", "Rate ratio (95\\% CI)", "\\ensuremath{p}-value"),
			 align=c('l', 'c', 'c'), 
             caption="Rate ratios for hospitalized or fatal COVID-19 within risk groups: vaccine dose as categoric variable with unvaccinated as reference category") %>%
    kableExtra::group_rows("No risk condition, unvaccinated within this group as reference category", 1, 2, bold=FALSE) %>% 
    kableExtra::group_rows("Moderate risk condition, unvaccinated within this group as reference category", 3, 4, bold=FALSE)  %>% 
    kableExtra::group_rows("Clinically extremely vulnerable, unvaccinated within this group as reference category", 5,  6, bold=FALSE)  %>% 
add_footnote(label=c("Presentation dates from 1 December 2020 to 14 July 2021.",
                     "Controls matched for age, sex, and primary care practice on date of presentation of case.",
                     "Adjusted for care home residence, number of adults in household, number of drug classes and recent hospital stay as covariates", 
                     "Rate ratios estimated in multivariable conditional logistic regression with all variables in model",  
                     "Vaccination status is number of doses administered at least 14 days before presentation date"), 
             notation="none") %>%
    column_spec(1, width="6cm") %>%
column_spec(2, width="4cm") %>%
column_spec(3, width="3cm") %>%
    kable_styling(latex_options=c("HOLD_position")) 

```

```{r hosprateratiosshieldgroups, echo=FALSE, message=FALSE}

table.hosp.shieldgr[, effect := gsub("vax", "vaccine", effect)] 
knitr::kable(table.hosp.shieldgr[12:19, ], 
             escape=FALSE, 
             booktabs=TRUE,
			 label="hosprateratiosshieldgroups",
             row.names=FALSE,
             col.names=c("Effect", "Rate ratio (95\\% CI)", "\\ensuremath{p}-value"),
			 align=c('l', 'c', 'c'), 
             caption="Rate ratios for hospitalized or fatal COVID-19 within shielding eligibility groups: vaccine dose encoded as numeric variable taking values 0, 1, 2") %>%
add_footnote(label=c("Presentation dates from 1 December 2020 to 14 July 2021.",
                     "Controls matched for age, sex, and primary care practice on date of presentation of case.",
                     "Rate ratios estimated in multivariable conditional logistic regression with all variables in model",  
                    "Vaccination status is number of doses administered at least 14 days before presentation date"), 
             notation="none") %>%
    column_spec(1, width="8cm") %>%
column_spec(2, width="4cm") %>%
column_spec(3, width="3cm") %>%
    kable_styling(latex_options=c("HOLD_position")) 

```

```{r hosprateratiosvaxgroups, echo=FALSE, message=FALSE}

startrow <- 1
knitr::kable(table.hosp.vaxgr[7:18,], 
             escape=FALSE, 
             booktabs=TRUE,
			 label="hosprateratiosvaxgroups",
             row.names=FALSE,
             col.names=c("Effect", "Rate ratio (95\\% CI)", "\\ensuremath{p}-value"),
			 align=c('l', 'c', 'c'), 
             caption="Rate ratios for hospitalized or fatal COVID-19 within risk groups: vaccine dose and product encoded as categoric variable with unvaccinated as reference category") %>%
    kableExtra::group_rows("No risk condition", startrow, startrow+3, bold=TRUE) %>% 
    kableExtra::group_rows("Moderate risk condition", startrow+4, startrow+7, bold=TRUE)  %>% 
    kableExtra::group_rows("Clinically extremely vulnerable", startrow+8, startrow+11, bold=TRUE)  %>% 
add_footnote(label=c("Presentation dates from 1 December 2020 to 14 July 2021.",
                     "Adjusted for care home residence, number of adults in household, number of drug classes dispensed, recent hospital stay and risk category.", 
                     "Controls matched for age, sex, and primary care practice on date of presentation of case.", 
                     "Vaccination status is number of doses administered at least 14 days before presentation date"), 
             notation="none") %>%
    column_spec(1, width="8cm") %>%
column_spec(2, width="4cm") %>%
column_spec(3, width="3cm") %>%
    kable_styling(latex_options=c("HOLD_position")) 

```

```{r hospvax2, echo=FALSE, message=FALSE}

knitr::kable(table.hosp.vax2, 
             escape=FALSE, 
             booktabs=TRUE,
			 label="hospvax2",
             row.names=TRUE, 
            caption="Risk factors for hospitalised or fatalCOVID-19 in those who had received 2 doses of vaccine at least 14 days before", 
             col.names=c(clean.header(colnames(table.severe.vax2)[1:2]),
                         "Rate ratio (95\\% CI)", "\\ensuremath{p}-value",
                         "Rate ratio (95\\% CI)", "\\ensuremath{p}-value")) %>%
    add_header_above(c(" "=3, "Univariate"=2, "Multivariable"=2)) %>%
    column_spec(column=1, width="4cm") %>%
    column_spec(column=2, width="2cm") %>%
    column_spec(column=3, width="2cm") %>%
    column_spec(column=4, width="3cm") %>%
    column_spec(column=5, width="1.7cm") %>%
    column_spec(column=6, width="2.7cm") %>%
    column_spec(column=7, width="1.7cm") %>%
    kableExtra::group_rows("Shielding eligibility category", 9, 14, bold=FALSE) %>%
   add_footnote(label=c("Percentages are column percentages for each variable",
                         "Rate ratios are from conditional logistic regression models matched for age, sex and general practice",
                         "Univariate rate ratios are for models with a single covariate",
                         "Multivariable rate ratios are for a model including all covariates shown in the table"),
                 notation="none") %>%
    kable_styling(latex_options=c("scale_down", "HOLD_position"))

```


```{r cohortseverevax2, echo=FALSE, message=FALSE}

knitr::kable(severe.2vax, 
             escape=FALSE, 
             booktabs=TRUE,
			 label="cohortseverevax2",
             row.names=TRUE, 
             col.names=c("Risk group", "Number of severe cases",
                         "Person-months", "Rate / 1000"),
             caption="Incidence of severe COVID-19 in clinically extremely vulnerable individuals who had received 2 doses of vaccine at least 14 days before, by risk subgroup") %>% 
     kable_styling(latex_options=c("HOLD_position"))

```
