---
title: "Efficacy of COVID-19 vaccination against severe COVID-19 and risk to  double-vaccinated individuals in Scotland: relationship to co-morbidities conferring  clinically extremely vulnerable status or moderate risk"
author:
  - name: Paul M McKeigue\textsuperscript{\getAff{Usher}}
    affiliation: HPS
  - name: Helen M Colhoun\textsuperscript{\getAff{IGMM}}
#    corresponding: yes
#    email: helen.colhoun@igmm.ed.ac.uk
    affiliation: HPS
address: 
- code: Usher
  address: Usher Institute, College of Medicine and Veterinary Medicine, University of Edinburgh, Teviot Place, Edinburgh EH8 9AG, Scotland. PM - Professor of Genetic Epidemiology and Statistical Genetics. NL - Clinical Senior Lecturer in Critical Care  
- code: IGMM
  address: Institute of Genetics and Cancer, College of Medicine and Veterinary Medicine, University of Edinburgh, Western General Hospital Campus, Crewe Road, Edinburgh EH4 2XUC, Scotland. HC - AXA Chair in Medical Informatics and Epidemiology
- code: HPS
  address: Public Health Scotland, Meridian Court, 5 Cadogan Street, Glasgow G2 6QE

header-includes:
  \usepackage{newunicodechar}
  \usepackage[T1]{fontenc}
  \let\origquote\quote
  \def\quote{\origquote\itshape}
  \usepackage{graphicx}
  \usepackage{geometry}
  \usepackage{longtable}
  \usepackage{booktabs}
  \usepackage{float}
  \floatplacement{figure}{H}
  \usepackage{array}
  \usepackage{threeparttable}
  \usepackage{longtable}
output: 
  rticles::nejm_article:
    includes:
      in_header: ./preamble.tex
    latex_engine: lualatex
    keep_tex: true
    fig_caption: yes
    md_extensions: -autolink_bare_uris
geometry: "left=2cm,right=2cm,top=2cm,bottom=2cm"
bibliography: ./covid.bib
csl: ./f1000.csl # ./plos.csl
always_allow_html: true
urlcolor: blue
linenumbers: false
linkcolor: cyan
---

```{r vax, echo=FALSE, warning=FALSE, message=FALSE}
library(kableExtra)

options(knitr.kable.NA = '.')
options(knitr.table.format = "latex") # adds tab: prefix to labels
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)

```
\newpage

# Abstract 
  
**Objectives** - To determine whether vaccine efficacy varies with risk category and shielding group and to investigate risk factors for severe COVID-19 in those who have received at least two doses of vaccine.  

**Design** - Matched case-control study.  

**Setting** - Population of Scotland from 1 December 2020 to 28 July 2021. 

**Main outcome measure** - Severe COVID-19, defined as cases with entry to critical care or fatal outcome.  

**Results** -The rate ratio for severe COVID-19 associated with two doses of vaccine was `r format.estci(table.riskgr[effect=="No risk condition: vax dose 2", rateratio])` in those without risk conditions, `r format.estci(table.riskgr[effect=="Moderate risk condition: vax dose 2", rateratio])` in those with moderate risk conditions, and `r format.estci(table.riskgr[effect=="Eligible for shielding: vax dose 2", rateratio])` in those eligible for shielding.  Among those eligible for shielding, there was a dose-response relationship and only weak evidence (p=0.04 in a test for interaction) that efficacy against hospitalized/severe disease was lower for the AZ vaccine than for the mRNA vaccines.   Among the double-vaccinated, 87% of severe cases and 77% of hospitalised cases had designated risk conditions or were eligible for shielding.  With those with no risk conditions as reference category, the rate ratio associated with receipt of a solid organ transplant among the double-vaccinated was `r format.estci(table.severe.vax2["Solid organ transplant", 3])` for severe disease and `r format.estci(table.hosp.vax2["Solid organ transplant", 3])` for hospitalisation. A risk score calculated from health records had moderate predictive performance (C-statistic 0.80) hospitalized cases and age-sex-matched controls among the double-vaccinated.   

**Conclusions** - 
Although efficacy of vaccination against severe disease in those without risk conditions remains high, it is now clear that efficacy in clinically extremely vulnerable individuals is considerably lower. Solid organ transplant recipients remain at high risk of severe disease even after two doses of vaccine.  

\newpage

# Introduction
The REACT-SCOT matched case-control study was established at the beginning of the epidemic to investigate risk factors for severe COVID-19 in the population of Scotland [@mckeigue_rapid_2020].  Using this framework, we have reported in detail on the relation of severe COVID-19 to risk factors including designated moderate risk conditions, drug prescribing and eligiblility for shielding [@mckeigue_rapid_2020;@mckeigue_relation_2021a;@mckeigue_relation_2021].  We reported a study of vaccine efficacy against severe disease in different risk groups based on data up to 16 March 2021 [@mckeigue_efficacy_2021].  As most people on the shielding list did not receive their first dose of vaccine until February 2021, there were too few people in this group who had received a second dose of vaccine at least 14 days earlier for the rate ratios associated with two vaccine doses to be estimated at this time.  

This report updates and extends the earlier analyses, with the following objectives: 

1. To examine the time course, since vaccination began, of the relation of severe COVID-19 to vaccination status and risk conditions.  

2. To determine whether vaccine efficacy varies with risk category and shielding group now that more data, including exposure to two doses of vaccine, are available.  

3. To investigate risk factors for infections causing severe illness or hospitalisation in those who have received at least two doses of vaccine.  

# Methods 
We used the REACT-SCOT study to take advantage of data linkages already established. The design has been described in detail previously [@mckeigue_rapid_2020]. In brief, for every incident case of COVID-19 in the population ten controls matched for one-year age, sex and primary care practice and alive on the day of presentation of the case that they were matched to were selected using the Community Health Index database.  COVID-19 cases are those with a positive nucleic acid test, or a hospital admission or death with COVID-19 ICD-10 codes. The REACT-SCOT case-control dataset is refreshed regularly and is linked to the vaccination database and to the regularly updated dataset of all individuals deemed eligible for the shielding programme.  This analysis is based on cases presenting from 1 December 2020 to 14 July 2021, so that we have at least 14 days of follow-up for each case.  This allows case severity status (hospitalisation, entry to critical care or death) to be assigned. For time-window analyses of length \ensuremath{2n + 1} days the time-window centred on 1 December 2020 includes the \ensuremath{n} days before that date.   

## Classification of risk categories
As previously [@mckeigue_rapid_2020], to minimise ascertainment bias we pre-specified the primary outcome measure as severe COVID-19,  defined as diagnosed cases with entry to critical care within 28 days of presentation or fatal outcome (any death within 28 days of a positive test or any death for which COVID-19 was coded as underlying cause).  Cases and controls were classified into three broad risk categories: no risk condition; at least one of the moderate risk conditions designated by public health agencies [@mckeigue_rapid_2020]; or eligible for shielding [@mckeigue_relation_2021].  For further analyses, the shielding category was subdivided as described previously  into six categories: solid organ transplant, specific cancers, severe respiratory conditions, other rare conditions, on immunosuppressants, and additional conditions [@mckeigue_relation_2021].   This corresponds to the list used by Public Health Scotland  [@health_protection_scotland_search_2020], with the small numbers in the group "pregnant with heart disease combined with the "other conditions" category.  For additional analyses the category "specific cancers" was split to allocate cancers of blood-forming organs (ICD-10 codes C81-C88, C90-C96) to a separate category.  

## Statistical analysis
Vaccination status was coded as the number of doses administered at least 14 days before presentation date. Vaccine doses administered less than 14 days before presentation date are ignored.  For estimates of effect by risk category, where the numbers of events are large, vaccination status was modelled as a factor comparing 1 dose or 2 doses with 0 doses as reference category.  For estimates of effect within shielding eligibility groups, and for comparisons between the mRNA and AZ vaccines where the numbers of events in each category are smaller, vaccination status was modelled as a numeric variable taking values \ensuremath{0, \frac{1}{2}, 1}  so that the effect parameter represents the rate ratio associated with 2 doses assuming the effect of 0, 1, 2 doses to be linear on the scale of the log rate ratio. 

Covariates included in the models were those that have been previously identified as strong predictors of severe disease in this population: care home residence, number of adults in household, number of drug classes dispensed and recent hospital stay [@mckeigue_rapid_2020;@mckeigue_relation_2021a;@mckeigue_relation_2021].  For care home residents the number of of adults in the household was coded as 1.  The number of drug classes was calculated as the number of distinct BNF subparagraph codes for which a prescription was dispensed between 15 and 240 days before presentation date.  As we have previously shown that severe COVID-19 in Scotland is associated with the number of non-cardiovascular but not the number of cardiovascular drug classes [@mckeigue_relation_2021a], the covariate included in the model was the number of non-cardiovascular drug classes.  The number of hospital diagnoses was calculated as the number of distinct ICD-10 chapters represented at least once in hospital discharge records between 25 days and 5 years before presentation date. Recent hospital stay was defined as any in-patient stay from 5 to 14 days before presentation date.

The effect of vaccination in each of the clinical vulnerability categories was estimated in a conditional logistic regression model (R function `survival::clogit`, package version_3.2-7, R version 3.6.3) fitted to the full dataset, specifying effects \ensuremath{\beta_{R2}, \dots, \beta_{RJ}} for the log rate ratio associated with risk categories 2 to \ensuremath{J} (\ensuremath{\beta_{R1} = 0} for the reference category \ensuremath{J=1}), and nested effects \ensuremath{\beta_{V1}, \dots, \beta_{VJ}} for the log rate ratio associated with vaccination in each of the \ensuremath{J} risk categories. With this incidence density sampling design, the conditional odds ratio is the rate ratio.  The efficacy of vaccination is 1 minus the rate ratio.  The strata in the conditional logistic regression model are matched sets: typically one case and up to 10 controls, but where two cases with the same age, sex and GP practice present on the same day the matched set comprises two cases and up to 20 controls.  When estimating the rate ratio within a risk group such as a shielding category, only cases and controls in that risk group are retained in the matched sets.   Matched sets in which all are vaccinated or none are vaccinated do not contribute to the rate ratio.   The unconditional odds ratios calculated from frequency tables of the vaccination status of cases and controls in each risk group cannot be used to estimate rate ratios [@breslow_estimation_1978;@greenland_need_1982].   The design controls not only for the matching factors of age, sex and general practice but also for calendar time.  Other variables included as covariates in the models had been previously identified as strongly associated with severe COVID-19: care home residence, number of adults in the household, number of distinct drug classes (BNF subparagraph codes) for which prescriptions were dispensed between 15 and 240 days before presentation date, and any hospital in-patient stay from 5 to 14 days before presentation date. 
<!---
# Cohort analysis of the shielding list
The case-control study can estimate only rate ratios.  To investigate the absolute rates of severe disease in those listed as clinically extremely vulnerable, we undertook a separate cohort study of all individuals who had ever been on the shielding list. At the time of this study  the dates of addition and removal from the shielding list, and linkage of the full cohort to vaccination status and mortality were not available to us, so this analysis is only provisional.  A Poisson regression model was fitted to a dataset formatted with one observation per 28-day person-time interval, and individuals censored at first event.  The event was defined as severe COVID-19 presenting within the person-time interval, and the covariates were sex, age, and shielding eligibility group.  The baseline hazard rate was specified as a natural spline function with 4 degrees of freedom.  Similar models were fitted with event indicator defined as hospitalized or fatal cases, or as any diagnosed case.  
--->

# Results
## Time course of vaccine efficacy against severe disease 
Fig \ref{fig:plotcases} shows the daily numbers of severe cases (averaged over 3-day sliding windows) by risk category.  In the first half of July the average daily number of severe cases among the 200,000 people still on the shielded list was about 4, equating to an incidence rate of about 0.6 per 1000 per month.  

Fig \ref{fig:plotrateratios} shows the time course of rate ratios (computed over 42-day sliding windows) for risk category and vaccination status, in a model that includes both these variables together with care home residence and recent hospital stay as covariates.  This shows that the rate ratio for severe disease associated with shielding eligibility, adjusted for vaccination status, has increased since 1 May, even though the absolute rate of severe disease in this group remains much lower than in December-January.  The rate ratios for severe disease associated with 1 dose and 2 doses of vaccine at least 14 days earlier (with unvaccinated as reference category) declined  steadily from January to June, implying that the efficacy increased despite the rapid replacement of the Alpha variant by the Delta variant during May 2020 [@sheikh_sarscov2_2021].   

## Relation of vaccine efficacy to risk conditions
Table \ref{tab:freqsvaxgr} tabulates risk/shielding group, vaccination status by product, and other risk factors in severe cases and controls with presentation dates from 1 December 2020 to 14 July 2021. Table \ref{tab:hospfreqsvaxgr} shows the same tabulation with case definition broadened to include all hospitalised cases and their matched controls. 

Table \ref{tab:rateratiosriskgroups} shows rate ratios associated with 1 and 2 vaccine doses (with 0 doses as reference category) in each of the three broad risk categories, in a model that includes risk categories (no risk conditions as reference category),  care home residence, number of adults in household, number of drug classes and recent hospital stay as covariates. The rate ratio associated with two doses of vaccine was `r format.estci(table.riskgr[effect=="No risk condition: vax dose 2", rateratio])` in those without risk conditions, `r format.estci(table.riskgr[effect=="Moderate risk condition: vax dose 2", rateratio])` in those with moderate risk conditions, and `r format.estci(table.riskgr[effect=="Eligible for shielding: vax dose 2", rateratio])` in those eligible for shielding.  On the scale of efficacy, these estimates are equivalent to 94% in those without risk conditions, 91% in those with risk conditions, and only 68% in those eligible for shielding.  To test formally for an effect of risk category on vaccine efficacy, a model was fitted with interaction terms for  risk category \ensuremath{\times} times vaccine dose.  In those with 2 doses, the effect (on the scale of rate ratio) of eligibility for shielding (with no risk condition as reference category) on the rate ratio associated with 2 doses of vaccine (0 doses as reference category) was `r format.estci(vaxriskgr.interaction)`.   

To exclude the possibility that misclassification of deaths within 28 days of a positive test as deaths from COVID-19 might account for apparently lower efficacy of vaccines in the clinically extremely vulnerable, the analysis was repeated with exclusion of fatal cases where COVID-19 was not certified as the underlying cause of death.  With this restricted case definition, the rate ratio associated with two doses of vaccine was `r format.estci(table.nonfatalorucod[effect=="No risk condition: vax dose 2", rateratio])` in those without risk conditions, `r format.estci(table.nonfatalorucod[effect=="Moderate risk condition: vax dose 2", rateratio])` in those with moderate risk conditions, and `r format.estci(table.nonfatalorucod[effect=="Eligible for shielding: vax dose 2", rateratio])` in those eligible for shielding.  
Table \ref{tab:hosprateratiosriskgroups} shows the same model with case definition broadened to include all hospitalised cases and their matched controls: the efficacy of 2 doses was lower in those eligible for shielding than in the other two risk categories.  

Table \ref{tab:rateratiosshieldgroups} shows rate ratios per vaccine dose, by broad risk category and shielding eligibility group.  The efficacy per dose was lower in all shielding eligibility groups than in those without risk conditions  Table \ref{tab:hosprateratiosshieldgroups} shows the same model with case definition broadened to include all hospitalised cases and their matched controls.  Although there is evidence of efficacy in all shielding eligibility groups, the efficacy estimate was lowest in solid organ transplant recipients.  

Table \ref{tab:rateratiosvaxgroups} shows rate ratios associated with 1 and 2 doses of each class of vaccine (with 0 doses as reference category) in each of the three broad risk categories. Table \ref{tab:hosprateratiosvaxgroups} shows the same model with case definition broadened to include all hospitalised cases and their matched controls.  In those eligible for shielding, a separate analysis was undertaken to test for difference in efficacy between the AZ vaccine and mRNA vaccines.  In conditional logistic regression models with vaccine dose and vaccine product centred at zero mean and other covariates as in Table  \ref{tab:hosprateratiosvaxgroups}, there was no evidence of lower efficacy against severe COVID-19 for the AZ vaccine and only weak evidence for lower efficacy against the broader category of hospitalized or fatal COVID-19: the rate ratio associated with vaccine dose was 1.51 (95% CI 0.66 to 1.03, _p_=0.04) times higher for the AZ vaccine than for the Pfizer vaccine.  

## Risk factors for severe COVID-19 in the double-vaccinated
Table \ref{tab:severevax2} shows risk factors for severe COVID-19 in cases and controls who had received 2 doses of vaccine at least 14 days before presentation date.  Table \ref{tab:hospvax2} shows the same analysis with case definition broadened to include hospitalized cases and matched controls who had received 2 doses of vaccine.  Of the variables that we have previously reported as risk factors for severe COVID-19 in the general population, care home residence and socioeconomic deprivation were not associated with severe disease in the double-vaccinated.  In this group the risk factors for severe disease were   designated risk conditions, other indicators of co-morbidity including numbers of hospital diagnoses and drug classes prescribed and transmission-related factors including number of adults in household and recent hospital stay.  Only 13% of double-vaccinated severe cases had no designated risk condition: 44% had at least one moderate risk condition and 43% were eligible for shielding.  With those with no risk conditions as reference category, the rate ratio associated with receipt of a solid organ transplant among the double-vaccinated was `r format.estci(table.severe.vax2["Solid organ transplant", 3])` for severe disease and `r format.estci(table.hosp.vax2["Solid organ transplant", 3])` for hospitalisation.

A risk score for hospitalised or fatal COVID-19 in the double-vaccinated calculated from the conditional logistic regression model had a C-statistic of 0.80.

<!---
## Associations with severe diseases after the first quarter of 2021

Table \ref{tab:freqsriskgroups} tabulates risk factors and vaccination status in severe cases and controls restricted to presentation dates from April to July 2021, by age dichotomized at 50 years.   Among severe cases aged over 50 years, 75% had been vaccinated with at least one dose, and 74% had a moderate risk condition or were eligible for shielding. Among severe cases aged less than 50, 81% had not been vaccinated, and 74% had no risk condition.  

Table \ref{tab:severeagevax} tabulates severe cases presenting from April to July 2021 by 10-year age group and vaccination status, showing that unvaccinated individuals aged 30-49 made up 129 of of the 171 severe cases among those aged less than 50 years. 

Table \ref{tab:casesnoriskchnums} tabulates severe cases and matched controls aged under 50 years without designated risk conditions presenting from April to July 2021, with frequencies in each chapter of ICD-10 of at least one hospital discharge diagnosis  from 5 years to 25 days before presentation date.  Table  \ref{tab:casesnoriskbnfchnums} tabulates for the same subset of cases and controls the frequencies in each chapter of the BNF of at least one prescription dispensed  from 240 to 15 days before presentation date.  In comparison with their matched controls, the cases had higher frequencies of admissions across several chapter headings including diseases of the digestive system, and other more non-specific chapter headings, and higher frequencies of at least one dispensed prescription in most chapters of the BNF.   
---> 

# Discussion
## Statement of principal findings
1. Although the efficacy of vaccination against severe disease in those without risk conditions remains high (at least 90%), it is now clear that the efficacy in clinically extremely vulnerable individuals is considerably lower (about 70%).  There is however a dose-response effect in this group: two doses are more effective than one.  

2. Solid organ transplant recipients remain at very high risk of severe disease even after two doses of vaccine: approximately 70-fold for severe disease and 30-fold for hospitalisation in comparison with double-vaccinated individuals of the same age and sex without risk conditions. 

3. There is only weak evidence that efficacy against severe disease disease is lower for the AZ vaccine than for the mRNA vaccines.  

4. Among the double-vaccinated, 87% of severe cases and 77% of hospitalised cases have designated risk conditions or are eligible for shielding.  A risk score calculated from health records has moderately high performance as a predictor of severe COVID-19 or hospitalisation among the double-vaccinated, independent of age and sex.    

## Strengths and limitations
Strengths of this study are the focus on severe cases rather than test-positives, the matched case-control design and the comprehensive linkage to e-health records 

The main limitation of this study is that no data on hospital prescribing are available.   Most biologic immunosuppressants and drugs for cancer are prescribed only in hospital, and the records of prescribing are not held in electronic form.  The national shielding list does not hold any information about drug therapy, and no information about diagnoses other than the seven broad categories listed as eligible for shielding.  

## Relation to other studies
A recent report based on primary care data covering 7.2 million people curated by the Royal College of General Practitioners Research and Surveillance Centre examined vaccine efficacy against symptomatic COVID-19 for which a medical consultation was recorded  [@whitaker_pfizerbiontech_2021].  For those who had been advised to shield, the efficacy after two doses of any vaccine was estimated as 92% in those aged less than 65 years and 84% in those aged 65 years and over.  For the "immunocompromised" group the estimated vaccine efficacy was somewhat lower at 74%, with a wide confidence interval. No separate analysis of vaccine efficacy in solid organ transplant recipients was reported.  


## Policy implications. 
The dose-response effect suggests that an additional dose might give more protection to double-vaccinated individuals who are clinically extremely vulnerable. 

For identifying those among the double-vaccinated who are at high risk of severe disease, a   risk score based on electronic health records has better discrimination than using only shielding eligibility.  However if vaccine supply is not constrained, a policy of offering booster vaccination to all those above an age threshold and all those with designated risk conditions would achievetogether with acombined would cover more than 80% of those at risk of severe disease.   


# References
<div id="refs"></div>

\newpage

# Tables

```{r freqsvaxgroups, echo=FALSE, message=FALSE}

knitr::kable(freqs.vaxgr, 
             escape=FALSE, 
             booktabs=TRUE,
			 label="freqsvaxgr",
             row.names=TRUE, 
			 align=c('r', 'r'), 
             caption="Numbers of controls and cases of severe COVID-19 by risk group and vaccine product") %>%
    add_footnote(label=c("Presentation dates from 1 December 2020 to 14 July 2021.",
                         "Severe COVID-19 defined as entry to critical care or death within 28 days of presentation.", 
                         "Controls matched for age, sex, and primary care practice on date of presentation of case.", 
                         "Vaccination status is number of doses administered at least 14 days before presentation date"), 
                 notation="none") %>%
    kableExtra::group_rows("Risk/shielding eligibility group", 6, 13, bold=FALSE) %>% 
    kableExtra::group_rows("Vaccination status", 14, 18, bold=FALSE) %>% 
    column_spec(1, width="5cm") %>%
    column_spec(2, width="4cm") %>%
    column_spec(3, width="3cm") %>%
   kable_styling(latex_options=c("HOLD_position")) 

```

```{r rateratiosriskgroups, echo=FALSE, message=FALSE}

knitr::kable(table.riskgr[7:12, ], 
             escape=FALSE, 
             booktabs=TRUE,
			 label="rateratiosriskgroups",
             row.names=FALSE,
             col.names=c("Effect", "Rate ratio (95\\% CI)", "\\ensuremath{p}-value"),
			 align=c('l', 'c', 'c'), 
             caption="Rate ratios for severe COVID-19 within risk groups: vaccine dose as categoric variable with unvaccinated as reference category") %>%
    kableExtra::group_rows("No risk condition, unvaccinated as reference category", 1, 2, bold=TRUE) %>% 
    kableExtra::group_rows("Moderate risk condition, unvaccinated as reference category", 3, 4, bold=TRUE)  %>% 
    kableExtra::group_rows("Eligible for shielding, unvaccinated as reference category", 5, 6, bold=TRUE)  %>% 
    add_footnote(label=c("Presentation dates from 1 December 2020 to 14 July 2021.",
                         "Severe COVID-19 defined as entry to critical care or death within 28 days of presentation.", 
                         "Controls matched for age, sex, and primary care practice on date of presentation of case.", 
                     "Adjusted for care home residence, number of adults in household, number of drug classes and recent hospital stay as covariates", 
                     "Rate ratios estimated in multivariable conditional logistic regression with all variables in model",  
                         "Vaccination status is doses administered at least 14 days fbefore presentation date"), 
                 notation="none") %>%
    column_spec(1, width="6cm") %>%
    column_spec(2, width="4cm") %>%
    column_spec(3, width="3cm") %>%
    kable_styling(latex_options=c("HOLD_position")) 

```

```{r rateratiosshieldgroups, echo=FALSE, message=FALSE}

table.shieldgr[, effect := gsub("vax", "vaccine", effect)] 
knitr::kable(table.shieldgr[14:19, ], 
             escape=FALSE, 
             booktabs=TRUE,
			 label="rateratiosshieldgroups",
             row.names=FALSE,
             col.names=c("Effect", "Rate ratio (95\\% CI)", "\\ensuremath{p}-value"),
			 align=c('l', 'c', 'c'), 
             caption="Rate ratios for severe COVID-19 within shielding eligibility groups: vaccine dose encoded as numeric variable taking values 0, 1/2, 1") %>%
add_footnote(label=c("Presentation dates from 1 December 2020 to 14 July 2021.",
                     "Severe COVID-19 defined as entry to critical care or death within 28 days of presentation.", 
                     "Controls matched for age, sex, and primary care practice on date of presentation of case.",
                     "Adjusted for care home residence, number of adults in household, number of drug classes and recent hospital stay as covariates", 
                     "Rate ratios estimated in multivariable conditional logistic regression with all variables in model",  
                     "Vaccination status is number of doses administered at least 14 days before presentation date"), 
             notation="none") %>%
    column_spec(1, width="8cm") %>%
column_spec(2, width="4cm") %>%
column_spec(3, width="3cm") %>%
    kable_styling(latex_options=c("HOLD_position")) 

```

```{r rateratiosvaxgroups, echo=FALSE, message=FALSE}

startrow <- 1
knitr::kable(table.vaxgr[7:18,], 
             escape=FALSE, 
             booktabs=TRUE,
			 label="rateratiosvaxgroups",
             row.names=FALSE,
             col.names=c("Effect", "Rate ratio (95\\% CI)", "\\ensuremath{p}-value"),
			 align=c('l', 'c', 'c'), 
             caption="Rate ratios for severe COVID-19 within risk groups: vaccine dose and product encoded as categoric variable with unvaccinated as reference category") %>%
    kableExtra::group_rows("No risk condition", startrow, startrow+3, bold=TRUE) %>% 
    kableExtra::group_rows("Moderate risk condition", startrow+4, startrow+7, bold=TRUE)  %>% 
    kableExtra::group_rows("Eligible for shielding", startrow+8, startrow+11, bold=TRUE)  %>% 
add_footnote(label=c("Presentation dates from 1 December 2020 to 14 July 2021.",
                     "Adjusted for care home residence, number of adults in household, number of drug classes dispensed, recent hospital stay and risk category.", 
                     "Controls matched for age, sex, and primary care practice on date of presentation of case.", 
                     "Vaccination status is number of doses administered at least 14 days before presentation date"), 
             notation="none") %>%
    column_spec(1, width="8cm") %>%
column_spec(2, width="4cm") %>%
column_spec(3, width="3cm") %>%
    kable_styling(latex_options=c("HOLD_position")) 

```

```{r severevax2, echo=FALSE, message=FALSE}

knitr::kable(table.severe.vax2, 
             escape=FALSE, 
             booktabs=TRUE,
			 label="severevax2",
             row.names=TRUE, 
            caption="Risk factors for severe COVID-19 in those who had received 2 doses of vaccine at least 14 days before", 
             col.names=c(clean.header(colnames(table.severe.vax2)[1:2]),
                         "Rate ratio (95\\% CI)", "\\ensuremath{p}-value",
                         "Rate ratio (95\\% CI)", "\\ensuremath{p}-value")) %>%
    add_header_above(c(" "=3, "Univariate"=2, "Multivariable"=2)) %>%
    column_spec(column=1, width="4cm") %>%
    column_spec(column=2, width="2cm") %>%
    column_spec(column=3, width="2cm") %>%
    column_spec(column=4, width="3cm") %>%
    column_spec(column=5, width="1.7cm") %>%
    column_spec(column=6, width="2.7cm") %>%
    column_spec(column=7, width="1.7cm") %>%
    kableExtra::group_rows("Shielding eligibility category", 9, 14, bold=FALSE) %>%
   add_footnote(label=c("Severe COVID-19 is defined by entry to critical care or fatal outcome", 
                         "Percentages are column percentages for each variable",
                         "Rate ratios are from conditional logistic regression models matched for age, sex and general practice",
                         "Univariate rate ratios are for models with a single covariate",
                         "Multivariable rate ratios are for a model including all covariates shown in the table"),
                 notation="none") %>%
    kable_styling(latex_options=c("scale_down", "HOLD_position"))

```

# Supplementary Material
\beginsupplement

## Supplementary Figures

```{r plotcases, echo=FALSE, warning=FALSE, message=FALSE, fig.pos = "H", fig.width=6, fig.asp=0.8, fig.cap="\\label{fig:plotcases} Daily severe cases by risk category"}

theme_set(theme_gray(base_size = 10))

p.byelig

```


```{r plotrateratios, echo=FALSE, warning=FALSE, message=FALSE, fig.pos = "H", fig.width=6, fig.asp=0.8, fig.cap="\\label{fig:plotrateratios} Rate ratios by 42-day sliding window. For each time window, the conditional logistic regression model includes all variables shown in the plot, together with care home residence and recent hospital stay. Line thickness is inversely proportional to standard error"}

theme_set(theme_gray(base_size = 10))

p.rateratio

```

## Supplementary Tables

```{r hospfreqsvaxgroups, echo=FALSE, message=FALSE}

knitr::kable(freqs.hosp.vaxgr, 
             escape=FALSE, 
             booktabs=TRUE,
			 label="hospfreqsvaxgr",
             row.names=TRUE, 
			 align=c('r', 'r'), 
             caption="Numbers of controls and cases of hospitalized or fatal COVID-19 by risk group and vaccine product") %>%
    add_footnote(label=c("Presentation dates from 1 December 2020 to 14 July 2021.",
                         "Controls matched for age, sex, and primary care practice on date of presentation of case.", 
                         "Vaccination status is number of doses administered at least 14 days before presentation date"), 
                 notation="none") %>%
    kableExtra::group_rows("Risk/shielding eligibility group", 6, 12, bold=FALSE) %>% 
    kableExtra::group_rows("Vaccination status", 14, 18, bold=FALSE) %>% 
    column_spec(1, width="5cm") %>%
    column_spec(2, width="4cm") %>%
    column_spec(3, width="3cm") %>%
   kable_styling(latex_options=c("HOLD_position")) 

```

```{r hosprateratiosriskgroups, echo=FALSE, message=FALSE}

knitr::kable(table.hosp.riskgr[7:12, ], 
             escape=FALSE, 
             booktabs=TRUE,
			 label="hosprateratiosriskgroups",
             row.names=FALSE,
             col.names=c("Effect", "Rate ratio (95\\% CI)", "\\ensuremath{p}-value"),
			 align=c('l', 'c', 'c'), 
             caption="Rate ratios for hospitalized or fatal COVID-19 within risk groups: vaccine dose as categoric variable with unvaccinated as reference category") %>%
    kableExtra::group_rows("No risk condition, unvaccinated as reference category", 1, 2, bold=FALSE) %>% 
    kableExtra::group_rows("Moderate risk condition, unvaccinated as reference category", 3, 4, bold=FALSE)  %>% 
    kableExtra::group_rows("Eligible for shielding, unvaccinated as reference category", 5,  6, bold=FALSE)  %>% 
add_footnote(label=c("Presentation dates from 1 December 2020 to 14 July 2021.",
                     "Controls matched for age, sex, and primary care practice on date of presentation of case.",
                     "Adjusted for care home residence, number of adults in household, number of drug classes and recent hospital stay as covariates", 
                     "Rate ratios estimated in multivariable conditional logistic regression with all variables in model",  
                     "Vaccination status is number of doses administered at least 14 days before presentation date"), 
             notation="none") %>%
    column_spec(1, width="6cm") %>%
column_spec(2, width="4cm") %>%
column_spec(3, width="3cm") %>%
    kable_styling(latex_options=c("HOLD_position")) 

```

```{r hosprateratiosshieldgroups, echo=FALSE, message=FALSE}

table.hosp.shieldgr[, effect := gsub("vax", "vaccine", effect)] 
knitr::kable(table.hosp.shieldgr[14:19, ], 
             escape=FALSE, 
             booktabs=TRUE,
			 label="hosprateratiosshieldgroups",
             row.names=FALSE,
             col.names=c("Effect", "Rate ratio (95\\% CI)", "\\ensuremath{p}-value"),
			 align=c('l', 'c', 'c'), 
             caption="Rate ratios for hospitalized or fatal COVID-19 within shielding eligibility groups: vaccine dose encoded as numeric variable taking values 0, 1, 2") %>%
add_footnote(label=c("Presentation dates from 1 December 2020 to 14 July 2021.",
                     "Controls matched for age, sex, and primary care practice on date of presentation of case.",
                     "Rate ratios estimated in multivariable conditional logistic regression with all variables in model",  
                    "Vaccination status is number of doses administered at least 14 days before presentation date"), 
             notation="none") %>%
    column_spec(1, width="8cm") %>%
column_spec(2, width="4cm") %>%
column_spec(3, width="3cm") %>%
    kable_styling(latex_options=c("HOLD_position")) 

```

```{r hosprateratiosvaxgroups, echo=FALSE, message=FALSE}

startrow <- 1
knitr::kable(table.hosp.vaxgr[7:18,], 
             escape=FALSE, 
             booktabs=TRUE,
			 label="hosprateratiosvaxgroups",
             row.names=FALSE,
             col.names=c("Effect", "Rate ratio (95\\% CI)", "\\ensuremath{p}-value"),
			 align=c('l', 'c', 'c'), 
             caption="Rate ratios for hospitalized or fatal COVID-19 within risk groups: vaccine dose and product encoded as categoric variable with unvaccinated as reference category") %>%
    kableExtra::group_rows("No risk condition", startrow, startrow+3, bold=TRUE) %>% 
    kableExtra::group_rows("Moderate risk condition", startrow+4, startrow+7, bold=TRUE)  %>% 
    kableExtra::group_rows("Eligible for shielding", startrow+8, startrow+11, bold=TRUE)  %>% 
add_footnote(label=c("Presentation dates from 1 December 2020 to 14 July 2021.",
                     "Adjusted for care home residence, number of adults in household, number of drug classes dispensed, recent hospital stay and risk category.", 
                     "Controls matched for age, sex, and primary care practice on date of presentation of case.", 
                     "Vaccination status is number of doses administered at least 14 days before presentation date"), 
             notation="none") %>%
    column_spec(1, width="8cm") %>%
column_spec(2, width="4cm") %>%
column_spec(3, width="3cm") %>%
    kable_styling(latex_options=c("HOLD_position")) 

```

```{r hospvax2, echo=FALSE, message=FALSE}

knitr::kable(table.hosp.vax2, 
             escape=FALSE, 
             booktabs=TRUE,
			 label="hospvax2",
             row.names=TRUE, 
            caption="Risk factors for hospitalised or fatalCOVID-19 in those who had received 2 doses of vaccine at least 14 days before", 
             col.names=c(clean.header(colnames(table.severe.vax2)[1:2]),
                         "Rate ratio (95\\% CI)", "\\ensuremath{p}-value",
                         "Rate ratio (95\\% CI)", "\\ensuremath{p}-value")) %>%
    add_header_above(c(" "=3, "Univariate"=2, "Multivariable"=2)) %>%
    column_spec(column=1, width="4cm") %>%
    column_spec(column=2, width="2cm") %>%
    column_spec(column=3, width="2cm") %>%
    column_spec(column=4, width="3cm") %>%
    column_spec(column=5, width="1.7cm") %>%
    column_spec(column=6, width="2.7cm") %>%
    column_spec(column=7, width="1.7cm") %>%
    kableExtra::group_rows("Shielding eligibility category", 9, 14, bold=FALSE) %>%
   add_footnote(label=c("Percentages are column percentages for each variable",
                         "Rate ratios are from conditional logistic regression models matched for age, sex and general practice",
                         "Univariate rate ratios are for models with a single covariate",
                         "Multivariable rate ratios are for a model including all covariates shown in the table"),
                 notation="none") %>%
    kable_styling(latex_options=c("scale_down", "HOLD_position"))

```
